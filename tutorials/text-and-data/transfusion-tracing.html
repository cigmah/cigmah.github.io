<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-08-04 Sun 19:34 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>4 Transfusion Tracing</title>
<meta name="generator" content="Org mode" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="main.css" rel="stylesheet">
<link href="../main.css" rel="stylesheet">
<link href="../../main.css" rel="stylesheet">
<link rel="shortcut icon" href="./favicon.ico">
<link rel="shortcut icon" href="../favicon.ico">
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<h1 class="title">4 Transfusion Tracing</h1>
</div>
<div id="content">
<input type="checkbox" id="sitemap-toggle" role="button" data-target="sitemap"/>
<label id="sitemap-label" for="sitemap-toggle">map</label>
<nav id="sitemap">
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-02-20 Wed]    </span></span>    <a href="../../about.html">About</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-05-29 Wed]    </span></span>    <a href="../../index.html">CIGMAH</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-02-20 Wed]    </span></span>    <a href="../../resources.html">Resources</a></li>
<li>Aorta/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-14 Sun]    </span></span>    <a href="../../aorta/help_wanted.html">AORTA - FAQ and Help Wanted</a></li>
</ul></li>
<li>Features/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-04-18 Thu]    </span></span>    <a href="../../features/kevin-shi.html">Participant Feature: Kevin Shi</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-04-12 Fri]    </span></span>    <a href="../../features/yingtong-li.html">Participant Feature: Yingtong Li</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-04-15 Mon]    </span></span>    <a href="../../features/chris-bain.html">Prof Chris Bain</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-29 Mon]    </span></span>    <a href="../../features/chris-wright.html">Prof Chris Wright</a></li>
</ul></li>
<li>Games/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-13 Sat]    </span></span>    <a href="../../games/base-in-balance.html">Base in Balance</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-06-07 Fri]    </span></span>    <a href="../../games/neurologic.html">NeuroLogic</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-13 Sat]    </span></span>    <a href="../../games/sti-bugs-n-drugs.html">STI Bugs 'n' Drugs</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-05-25 Sat]    </span></span>    <a href="../../games/tarsal-tumble.html">Tarsal Tumble</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-13 Sat]    </span></span>    <a href="../../games/what-dipstick.html">What Dipstick?</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-07-13 Sat]    </span></span>    <a href="../../games/worst-offender.html">Worst Offender</a></li>
</ul></li>
<li>Misc/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-02 Fri]    </span></span>    <a href="../../misc/puzzle-index.html">Topics and Puzzle Index</a></li>
</ul></li>
<li>Tutorials/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-02 Fri]    </span></span>    <a href="../intro.html">Introduction</a></li>
<li>Tutorials/Text-And-Data/
<ul class="org-ul">
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-05 Mon]    </span></span>    <a href="introduction.html">1 Introduction to Text and Data</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-04 Sun]    </span></span>    <a href="mood-diary.html">2 Mood Diary</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-03 Sat]    </span></span>    <a href="contraindicated.html">3 Contraindicated</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-02 Fri]    </span></span>    <a href="transfusion-tracing.html">4 Transfusion Tracing</a></li>
<li><span class="timestamp-wrapper"><span class="timestamp">[2019-08-01 Thu]    </span></span>    <a href="mapping-meningitis.html">5 Mapping Meningitis</a></li>
</ul></li>
</ul></li>
</ul>
</nav>

<br>


<div class="figure">
<p><img src="../../static/icons/png/haem.png" alt="haem.png" />
</p>
</div>

<div id="outline-container-orgab4b145" class="outline-2">
<h2 id="orgab4b145">Problem</h2>
<div class="outline-text-2" id="text-orgab4b145">
<p>
Your hospital's infectious diseases department has queried two recent diagnoses
of Hepatitis C in patients who have both received blood traced to the same blood
donor. While the transmission of blood-borne infections through blood
transfusions is <i>exceedingly</i> rare in the modern age, your hospital has raised
an inquiry for due caution.
</p>

<p>
You have been provided with trimmed, deidentified transfusion logs over
6 months (from 1st January 2020 to 30th June 2020) in the following format
(first five lines):
</p>

<div class="org-src-container">
<pre class="src src-text">2020-01-01    D012311    095703
2020-01-01    D041530    028619
2020-01-01    D007809    026117
2020-01-01    D037810    021170
2020-01-01    D099727    042349
</pre>
</div>

<p>
You have 50000 lines in your input. Each log begins with a date of transfusion,
a donor ID ("D" followed by six digits) and the ID of the patient who received a
blood product traced to that donor. A single donor ID and patient ID correspond
to a single donor/patient; some patients receive more than one blood transfusion
and some donors contribute more than one blood product that is transfused, and
therefore each may be repeated one or more times in the logs.
</p>

<p>
You have also been provided with all the patients in this list of transfusion
logs who have been diagnosed with Hepatitis C (though not necessarily as a
result of transfusion) in 2020 in the following format (first five lines):
</p>

<div class="org-src-container">
<pre class="src src-text">2020-02-15    062923
2020-02-24    099772
2020-03-09    085550
2020-03-13    051412
2020-03-14    055593
</pre>
</div>

<p>
The first column lists the date of diagnosis, and the second lists the patient
ID of the patient diagnosed, which matches with the patient ID in the
transfusion logs. You may assume any patient not in this list was diagnosed with
Hepatitis C.
</p>

<p>
<b>Your task</b> is to:
</p>

<ol class="org-ol">
<li>Process the transfusion logs and list of Hepatitis C diagnoses into a
workable data format.</li>
<li>Join the data and determine the ID of the source donor from whom patients are most
likely to have received a transfusion prior to being diagnosed with Hepatitis
C.</li>
</ol>

<p>
<a href="./input-transfusion-tracing-transfusions.txt">Click here to download the log of transfusions (1,612KB, .txt)</a>
</p>

<p>
<a href="./input-transfusion-tracing-infections.txt">Click here to download the list of Hepatitis C diagnoses (2KB, .txt).</a>
</p>
</div>
</div>

<div id="outline-container-orgd68f439" class="outline-2">
<h2 id="orgd68f439">Solution</h2>
<div class="outline-text-2" id="text-orgd68f439">
<details><summary>Click here to show the answer.</summary>
<p>
The donor ID from which patients with Hepatitis C were most likely to have
received a transfusion product from is <b>D086725</b> (six patients received a
transfusion product from this donor prior to being diagnosed, versus the next
most common with two patients).
</p>
</details>

<details><summary>Click here to show the solution.</summary>

<blockquote>
<p>
We haven't explained this step-by-step in full yet, but here's the solution as
it stands at the moment. A more detailed explanation will appear shortly.
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #e45649;">with</span> <span style="color: #a626a4;">open</span>(<span style="color: #50a14f;">'input-transfusion-tracing-infections.txt'</span>) <span style="color: #e45649;">as</span> infile:
    <span style="color: #6a1868;">RAW_INFECTIONS</span> = infile.readlines()
<span style="color: #e45649;">with</span> <span style="color: #a626a4;">open</span>(<span style="color: #50a14f;">'input-transfusion-tracing-transfusions.txt'</span>) <span style="color: #e45649;">as</span> infile:
    <span style="color: #6a1868;">RAW_TRANSFUSIONS</span> = infile.readlines()

<span style="color: #e45649;">import</span> re
<span style="color: #e45649;">from</span> typing <span style="color: #e45649;">import</span> List
<span style="color: #e45649;">from</span> datetime <span style="color: #e45649;">import</span> datetime

<span style="color: #e45649;">def</span> <span style="color: #a626a4;">procdate</span>(row):
    datetime_string, *<span style="color: #6a1868;">rest</span> = row
    <span style="color: #e45649;">return</span> [ datetime.strptime(datetime_string, <span style="color: #50a14f;">'%Y-%m-%d'</span>), *rest ]

<span style="color: #6a1868;">INFECTIONS</span> = [procdate(line.split()) <span style="color: #e45649;">for</span> line <span style="color: #e45649;">in</span> RAW_INFECTIONS]
<span style="color: #6a1868;">TRANSFUSIONS</span> = [procdate(line.split()) <span style="color: #e45649;">for</span> line <span style="color: #e45649;">in</span> RAW_TRANSFUSIONS]

<span style="color: #e45649;">def</span> <span style="color: #a626a4;">received_prior</span>(infection_data):
    <span style="color: #e45649;">return</span> <span style="color: #a626a4;">set</span>([
        transfusion[<span style="color: #da8548; font-weight: bold;">1</span>] <span style="color: #e45649;">for</span> transfusion <span style="color: #e45649;">in</span> TRANSFUSIONS
        <span style="color: #e45649;">if</span> (transfusion[<span style="color: #da8548; font-weight: bold;">0</span>] &lt; infection_data[<span style="color: #da8548; font-weight: bold;">0</span>] <span style="color: #e45649;">and</span> transfusion[<span style="color: #da8548; font-weight: bold;">2</span>] == infection_data[<span style="color: #da8548; font-weight: bold;">1</span>])
    ])

<span style="color: #6a1868;">POSSIBLE_DONORS</span> = [ received_prior(infection) <span style="color: #e45649;">for</span> infection <span style="color: #e45649;">in</span> INFECTIONS ]

<span style="color: #e45649;">from</span> collections <span style="color: #e45649;">import</span> Counter

<span style="color: #6a1868;">COUNTS</span> = Counter([
    donor
    <span style="color: #e45649;">for</span> donor_list <span style="color: #e45649;">in</span> POSSIBLE_DONORS
    <span style="color: #e45649;">for</span> donor <span style="color: #e45649;">in</span> donor_list
])

<span style="color: #e45649;">print</span>(COUNTS.most_common()[:<span style="color: #da8548; font-weight: bold;">5</span>])
</pre>
</div>
</details>
</div>

<div id="outline-container-orga08c12c" class="outline-3">
<h3 id="orga08c12c">Data Generation</h3>
<div class="outline-text-3" id="text-orga08c12c">
<details><summary>Click here to show the data generation code.</summary>
<p>
We will define 5000 patients and 10000 transfusion events involving 1000 unique
donor IDs.
</p>

<p>
First, we initialise lists of patient IDs and donor IDs.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #e45649;">from</span> random <span style="color: #e45649;">import</span> choices

<span style="color: #6a1868;">NUM_PATIENTS</span> = <span style="color: #da8548; font-weight: bold;">20000</span>
<span style="color: #6a1868;">NUM_TRANSFUSIONS</span> = <span style="color: #da8548; font-weight: bold;">50000</span>
<span style="color: #6a1868;">NUM_DONORS</span> = <span style="color: #da8548; font-weight: bold;">5000</span>

<span style="color: #6a1868;">PATIENT_IDS</span> = [<span style="color: #50a14f;">'{0:06d}'</span>.<span style="color: #a626a4;">format</span>(i) <span style="color: #e45649;">for</span> i <span style="color: #e45649;">in</span> choices(<span style="color: #a626a4;">range</span>(<span style="color: #da8548; font-weight: bold;">100000</span>), k=NUM_PATIENTS)]
<span style="color: #6a1868;">DONOR_IDS</span> = [<span style="color: #50a14f;">'D{0:06d}'</span>.<span style="color: #a626a4;">format</span>(i) <span style="color: #e45649;">for</span> i <span style="color: #e45649;">in</span> choices(<span style="color: #a626a4;">range</span>(<span style="color: #da8548; font-weight: bold;">100000</span>), k=NUM_DONORS)]

</pre>
</div>

<p>
We will then select one of the donor IDs as the source of infection. The list is
in a random order, so we can just choose the first one.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #6a1868;">CONTAMINATED_ID</span> = DONOR_IDS[<span style="color: #da8548; font-weight: bold;">0</span>]
<span style="color: #e45649;">print</span>(CONTAMINATED_ID)
</pre>
</div>

<pre class="example">
D086725
</pre>


<p>
Next, we will simulate a series of transfusion events. First, we create a
collection of datetimes - let us make the datetimes between 2020-01-01 and
2020-06-30.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #e45649;">from</span> datetime <span style="color: #e45649;">import</span> datetime, timedelta

<span style="color: #6a1868;">START_DATE</span> = datetime(<span style="color: #da8548; font-weight: bold;">2020</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">1</span>)
<span style="color: #6a1868;">END_DATE</span> = datetime(<span style="color: #da8548; font-weight: bold;">2020</span>, <span style="color: #da8548; font-weight: bold;">6</span>, <span style="color: #da8548; font-weight: bold;">30</span>)
<span style="color: #6a1868;">DURATION</span> = (END_DATE - START_DATE).days

<span style="color: #6a1868;">EVENT_DELTAS</span> = choices(<span style="color: #a626a4;">range</span>(DURATION), k=NUM_TRANSFUSIONS)
EVENT_DELTAS.sort() <span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">sort in place</span>
<span style="color: #6a1868;">EVENT_DATETIMES</span> = [START_DATE + timedelta(days=d) <span style="color: #e45649;">for</span> d <span style="color: #e45649;">in</span> EVENT_DELTAS]
</pre>
</div>

<p>
For each event, we will randomly choose a donor ID and a patient ID. For donor
IDs which don't match the ID of the contaminated product, we will set the
probability of HCV infection to 0.001 (1 in 1000); note that this is <i>much</i> higher
than the actual risk of HCV infection from non-contaminated products + the
actual incidence of HCV (we have set the rate here to accommodate the fact that
we are not producing 100s of thousands of data points). If the ID matches the
contaminated product, we will set the probability to 0.5.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #e45649;">from</span> random <span style="color: #e45649;">import</span> random, randint

<span style="color: #6a1868;">infections</span> = []
<span style="color: #6a1868;">infected</span> = <span style="color: #a626a4;">set</span>()

<span style="color: #6a1868;">SELECTED_DONORS</span> = choices(DONOR_IDS, k=NUM_TRANSFUSIONS)
<span style="color: #6a1868;">SELECTED_PATIENTS</span> = choices(PATIENT_IDS, k=NUM_TRANSFUSIONS)

<span style="color: #6a1868;">EVENTS</span> = <span style="color: #a626a4;">list</span>(<span style="color: #a626a4;">zip</span>(EVENT_DATETIMES, SELECTED_DONORS, SELECTED_PATIENTS))

<span style="color: #e45649;">for</span> event, donor, patient <span style="color: #e45649;">in</span> EVENTS:

    <span style="color: #e45649;">if</span> donor == CONTAMINATED_ID:
        <span style="color: #6a1868;">chance_of_infection</span> = <span style="color: #da8548; font-weight: bold;">0.5</span>
    <span style="color: #e45649;">else</span>:
        <span style="color: #6a1868;">chance_of_infection</span> = <span style="color: #da8548; font-weight: bold;">0.001</span>

    <span style="color: #e45649;">if</span> random() &lt; chance_of_infection:
        <span style="color: #e45649;">if</span> patient <span style="color: #e45649;">not</span> <span style="color: #e45649;">in</span> infected:
            <span style="color: #6a1868;">incubation_period</span> = randint(<span style="color: #da8548; font-weight: bold;">14</span>, <span style="color: #da8548; font-weight: bold;">180</span>)
            infections.append((event + timedelta(days=incubation_period), patient))
            infected.add(patient)

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">Sort infections in-place by discovery time.</span>
infections.sort(key=<span style="color: #e45649;">lambda</span> infection: infection[<span style="color: #da8548; font-weight: bold;">0</span>])

</pre>
</div>

<p>
Finally, we format and save the results.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #e45649;">from</span> typing <span style="color: #e45649;">import</span> Tuple

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">FORMATTING EVENTS</span>
<span style="color: #e45649;">def</span> <span style="color: #a626a4;">format_event</span>(event: Tuple[datetime, <span style="color: #a626a4;">str</span>, <span style="color: #a626a4;">str</span>]) -&gt; <span style="color: #a626a4;">str</span>:
    <span style="color: #6a1868;">formatted</span> = f<span style="color: #50a14f;">'{event[0]:%Y-%m-%d}    {event[1]}    {event[2]}'</span>
    <span style="color: #e45649;">return</span> formatted

<span style="color: #6a1868;">FORMATTED_EVENTS</span> = [format_event(event) <span style="color: #e45649;">for</span> event <span style="color: #e45649;">in</span> EVENTS]
<span style="color: #6a1868;">SEPARATOR</span> = <span style="color: #50a14f;">'\n'</span>
<span style="color: #6a1868;">EVENT_STRING</span> = SEPARATOR.join(FORMATTED_EVENTS)

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">FORMATTING INFECTIONS</span>
<span style="color: #e45649;">def</span> <span style="color: #a626a4;">format_infection</span>(infection: Tuple[datetime, <span style="color: #a626a4;">str</span>]) -&gt; <span style="color: #a626a4;">str</span>:
    <span style="color: #6a1868;">formatted</span> = f<span style="color: #50a14f;">'{infection[0]:%Y-%m-%d}    {infection[1]}'</span>
    <span style="color: #e45649;">return</span> formatted

<span style="color: #6a1868;">FORMATTED_INFECTIONS</span> = [format_infection(infection) <span style="color: #e45649;">for</span> infection <span style="color: #e45649;">in</span> infections]
<span style="color: #6a1868;">INFECTION_STRING</span> = SEPARATOR.join(FORMATTED_INFECTIONS)

<span style="color: #9ca0a4;"># </span><span style="color: #9ca0a4;">FILE IO</span>
<span style="color: #6a1868;">EVENT_FILENAME</span> = <span style="color: #50a14f;">'input-transfusion-tracing-transfusions.txt'</span>
<span style="color: #6a1868;">INFECTION_FILENAME</span> = <span style="color: #50a14f;">'input-transfusion-tracing-infections.txt'</span>

<span style="color: #e45649;">with</span> <span style="color: #a626a4;">open</span>(EVENT_FILENAME, <span style="color: #50a14f;">'w+'</span>) <span style="color: #e45649;">as</span> outfile:
    outfile.write(EVENT_STRING)

<span style="color: #e45649;">with</span> <span style="color: #a626a4;">open</span>(INFECTION_FILENAME, <span style="color: #50a14f;">'w+'</span>) <span style="color: #e45649;">as</span> outfile:
    outfile.write(INFECTION_STRING)
</pre>
</div>
</details>
</div>
</div>
</div>
</div>
</body>
</html>
