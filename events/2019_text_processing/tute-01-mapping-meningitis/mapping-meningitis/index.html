<!DOCTYPE html>
<html><head>
    
    
    <title> CIGMAH - Mapping Meningitis </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="">
    <meta name="theme-color" content="#000000" />
    <link rel="icon" href="https://cigmah.org/favicon.ico">
    <script src="https://cigmah.org/js/toggles.js"></script>
    <link type="text/css" rel="stylesheet" href=https://cigmah.org/sass/main.css>
    <link rel="canonical" href="https://cigmah.org/events/2019_text_processing/tute-01-mapping-meningitis/mapping-meningitis/">
</head>
<body>
        <header>

            <nav id="nav-menu-toggle" onClick="toggleNav()">
                <div id="menu-text">â˜°</div>
                <div id="cigmah-brand">
                    <div id="cigmah-icon">
                        <img src="https://cigmah.org/img/cigmah-icon.png">
                    </div>
                    <div id="cigmah-text">
                        CIGMAH
                    </div>
                </div>
            </nav>

            <nav id="nav-bar">

<ul id="nav-link-list" onClick="()">

    <li
        class="nav-link-list-item "
    >
        <a
            class="nav-link-list-link "
            id="nav-cigmah-link"
            href=https://cigmah.org/
        >
            <img id="nav-cigmah-link-icon" src="/img/cigmah-icon-small.png">
            <div>CIGMAH</div>
        </a>
    </li>

  
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/about/
        >
            About
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/events/
        >
            Events
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/tools/
        >
            Tools
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/resources/
        >
            Resources
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/blog/
        >
            Blog
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/contact/
        >
            Contact
        </a>
    </li>
    

    <li
        class="nav-link-list-item"
        id="nav-right-item"
        >
        <a
            href="https://aorta.cigmah.org"
            id="nav-aorta-link"
            class="nav-link-list-link"
        >
            <img id="nav-aorta-link-icon" src="/img/aorta-icon.png">
            <div id="nav-aorta-link">AORTA</div>
        </a>
    </li>
</ul>
</nav>

        </header>

        <main>



<section class="normal-page">
    <article id="side-navigation">
        <article id="toggle-side-navigation-container">

            
            <a href="https://cigmah.org/events/2019_text_processing/tute-01-mood-diary/mood-diary/" id="back"> &lt;&lt; </a>
            

            <button id="toggle-side-navigation" onClick="toggleSideNav()">Show Articles</button>

            
            <a href="https://cigmah.org/events/2019_text_processing/tute-01-contraindicated/contraindicated/" id="next"> &gt;&gt; </a>
            

        </article>

        <ul id="side-navigation-list">

            
            <li class="side-navigation-parent">
                <a href="https://cigmah.org/events/">Events</a>
            </li>
            


            <li class="side-navigation-section">
                <a href="https://cigmah.org/events/2019_text_processing/">
                    Night 1: Text Processing
                </a>
            </li>

            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-contraindicated/contraindicated/">Contraindicated</a>
            </li>
            
            <li
                class="side-navigation-item  active "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-mapping-meningitis/mapping-meningitis/">Mapping Meningitis</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-mood-diary/mood-diary/">Mood Diary</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-transfusion-tracing/transfusion-tracing/">Transfusion Tracing</a>
            </li>
            

        </ul>

    </article>

    <section id="container">

        <article id="content">
            <header id="content-header">
            <h1 id="content-title"> Mapping Meningitis </h1>

            
                <div id="subtitle">
                    <div>  </div>
                </div>
            

            </div>

            </header>

            <section id="content-body">
                
<h2 id="headline-1">
Problem
</h2>
<p>
Meningitis is spreading through Melbourne at a previously unprecedented rate. To
investigate, your clinical supervisor has acquired a text file of abridged and
deidentified CSF results from patients with suspected meningitis in Melbourne
over a 24-week period starting from March 1st 2020.
</p>
<p>
Here is the first result. You have a collection of 1000 results in this format.
</p>
<div class="src src-text">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">PATIENT ID: 882490
LOCATION: (-36.852366,145.388525)
SAMPLE TIMESTAMP: 2020-05-17

RESULTS:
Turbid.

CELL COUNT:  164.47  x 10^6 / L (lymphocytic predominance)
GLUCOSE:     3.75  mmol/L
LACTATE:     1.99  mmol/L
PROTEIN:     0.22  g/L</code></pre></div>
</div>
<p>
<strong><strong>Your task</strong></strong> is to:
</p>
<ol>
<li>
<p>
Process and classify each result as most suggestive of no-infection,
bacterial, viral or fungal meningitis.
</p>
</li>
<li>
<p>
Plot a visual representation, of cases, their classification of meningitis,
and their location over the 24-week period from March 1st 2020.
</p>
</li>
<li>
<p>
Interpret your findings.
</p>
</li>
</ol>
<p>
<a href="../input-mapping-meningitis.txt">Click here to download your text input (332KB, .txt).</a>
</p>
<p>
You may find <a href="https://www.rcpa.edu.au/Manuals/RCPA-Manual/Pathology-Tests/C/Cerebrospinal-fluid-examination">The RCPA Manual</a> on CSF interpretation to be useful for this
problem.
</p>
<h2 id="headline-2">
Solution
</h2>
<details><summary>Click here to show the answer.</summary>
<p>
[2019-08-05 Mon 17:03] - Updated with GIF.
</p>
<p>
Here&#39;s a plot of cases by latitude and longitude as an animated GIF with steps
of one week. We haven&#39;t put a legend on here yet, but red indicates bacterial
meningitis, green indicates viral, and blue indicates fungal (grey indicates
none). Transparencies indicate time - the earliest cases are most transparent,
later cases are more opaque.
</p>
<p>
<img src="../mapping-meningitis.gif" alt="../mapping-meningitis.gif" title="../mapping-meningitis.gif" />
</p>
<p>
We can see there&#39;s a cluster of bacterial meningitis cases popping up around a
coordinate near (-37.8, 145.0). Plotting the coordinates on a map might be
helpful.
</p>
</details>
<details><summary>Click here to show the solution.</summary>
<blockquote>
<p>
We haven&#39;t explained this step-by-step in full yet, but here&#39;s the solution as
it stands at the moment. A more detailed explanation will appear shortly.
</p>
</blockquote>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">re</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">pandas</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">pd</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">glob</span>
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">enum</span> <span style="color:#008000;font-weight:bold">import</span> Enum
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">datetime</span> <span style="color:#008000;font-weight:bold">import</span> datetime, timedelta
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">matplotlib</span> <span style="color:#008000;font-weight:bold">import</span> pyplot <span style="color:#008000;font-weight:bold">as</span> plt
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">matplotlib</span> <span style="color:#008000;font-weight:bold">import</span> colors
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">typing</span> <span style="color:#008000;font-weight:bold">import</span> List, Tuple

SEPARATOR <span style="color:#666">=</span> <span style="color:#ba2121">&#39;-&#39;</span> <span style="color:#666">*</span> <span style="color:#666">80</span>

<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(<span style="color:#ba2121">&#39;input-mapping-meningitis.txt&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> infile:
    RAW <span style="color:#666">=</span> infile<span style="color:#666">.</span>read()<span style="color:#666">.</span>split(SEPARATOR)

MATCH_RE <span style="color:#666">=</span> (
    <span style="color:#ba2121">&#39;ID:\s+(\d+).*&#39;</span>
    <span style="color:#ba2121">&#39;ON:\s+\((.*?),(.*?)\).*&#39;</span>
    <span style="color:#ba2121">&#39;MP:\s+([\d\-]*).*&#39;</span>
    <span style="color:#ba2121">&#39;NT:\s+([\.\d]*).*&#39;</span>
    <span style="color:#ba2121">&#39;\((.*)\).*&#39;</span>
    <span style="color:#ba2121">&#39;SE:\s+([\.\d]*).*&#39;</span>
    <span style="color:#ba2121">&#39;TE:\s+([\.\d]*).*&#39;</span>
    <span style="color:#ba2121">&#39;IN:\s+([\.\d]*).*&#39;</span>
)

MATCHER <span style="color:#666">=</span> re<span style="color:#666">.</span>compile(MATCH_RE, re<span style="color:#666">.</span>DOTALL)

DATA <span style="color:#666">=</span> [MATCHER<span style="color:#666">.</span>findall(record)[<span style="color:#666">0</span>] <span style="color:#008000;font-weight:bold">for</span> record <span style="color:#a2f;font-weight:bold">in</span> RAW]

DATAFRAME <span style="color:#666">=</span> pd<span style="color:#666">.</span>DataFrame(
    DATA,
    columns<span style="color:#666">=</span>[
        <span style="color:#ba2121">&#39;patient_id&#39;</span>,
        <span style="color:#ba2121">&#39;latitude&#39;</span>,
        <span style="color:#ba2121">&#39;longitude&#39;</span>,
        <span style="color:#ba2121">&#39;date&#39;</span>,
        <span style="color:#ba2121">&#39;cell_count&#39;</span>,
        <span style="color:#ba2121">&#39;predominance&#39;</span>,
        <span style="color:#ba2121">&#39;glucose&#39;</span>,
        <span style="color:#ba2121">&#39;lactate&#39;</span>,
        <span style="color:#ba2121">&#39;protein&#39;</span>,
    ]
)

DATAFRAME <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>astype({
    <span style="color:#ba2121">&#39;latitude&#39;</span>: <span style="color:#008000">float</span>,
    <span style="color:#ba2121">&#39;longitude&#39;</span>: <span style="color:#008000">float</span>,
    <span style="color:#ba2121">&#39;cell_count&#39;</span>: <span style="color:#008000">float</span>,
    <span style="color:#ba2121">&#39;glucose&#39;</span>: <span style="color:#008000">float</span>,
    <span style="color:#ba2121">&#39;lactate&#39;</span>: <span style="color:#008000">float</span>,
    <span style="color:#ba2121">&#39;protein&#39;</span>: <span style="color:#008000">float</span>
})

DATAFRAME[<span style="color:#ba2121">&#39;date&#39;</span>] <span style="color:#666">=</span> pd<span style="color:#666">.</span>to_datetime(DATAFRAME[<span style="color:#ba2121">&#39;date&#39;</span>])

<span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">ResultType</span>(Enum):
    NOT_MENINGITIS <span style="color:#666">=</span> <span style="color:#666">0</span>
    BACTERIAL <span style="color:#666">=</span> <span style="color:#666">1</span>
    VIRAL <span style="color:#666">=</span> <span style="color:#666">2</span>
    FUNGAL <span style="color:#666">=</span> <span style="color:#666">3</span>

<span style="color:#408080;font-style:italic"># Simplified, based on RCPA manual</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">classify</span>(row) <span style="color:#666">-&gt;</span> ResultType:
    <span style="color:#008000;font-weight:bold">if</span> row<span style="color:#666">.</span>cell_count <span style="color:#666">&gt;</span> <span style="color:#666">5</span>:
        <span style="color:#008000;font-weight:bold">if</span> row<span style="color:#666">.</span>glucose <span style="color:#666">&lt;</span> <span style="color:#666">2.8</span>:
            <span style="color:#008000;font-weight:bold">if</span> <span style="color:#ba2121">&#39;polymorphonuclear&#39;</span> <span style="color:#a2f;font-weight:bold">in</span> row<span style="color:#666">.</span>predominance:
                <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>BACTERIAL
            <span style="color:#008000;font-weight:bold">elif</span> <span style="color:#ba2121">&#39;lymphocytic&#39;</span> <span style="color:#a2f;font-weight:bold">in</span> row<span style="color:#666">.</span>predominance:
                <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>FUNGAL
            <span style="color:#008000;font-weight:bold">else</span>:
                <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>NOT_MENINGITIS
        <span style="color:#008000;font-weight:bold">else</span>:
            <span style="color:#008000;font-weight:bold">if</span> <span style="color:#ba2121">&#39;lymphocytic&#39;</span> <span style="color:#a2f;font-weight:bold">in</span> row<span style="color:#666">.</span>predominance:
                <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>VIRAL
            <span style="color:#008000;font-weight:bold">else</span>:
                <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>NOT_MENINGITIS
    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">return</span> ResultType<span style="color:#666">.</span>NOT_MENINGITIS

DATAFRAME[<span style="color:#ba2121">&#39;classification&#39;</span>] <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>apply(classify, axis<span style="color:#666">=</span><span style="color:#666">1</span>)

ORDINAL_DAYS <span style="color:#666">=</span> DATAFRAME[<span style="color:#ba2121">&#34;date&#34;</span>]<span style="color:#666">.</span>apply(<span style="color:#008000;font-weight:bold">lambda</span> x: x<span style="color:#666">.</span>toordinal())
INTENSITIES <span style="color:#666">=</span> (ORDINAL_DAYS <span style="color:#666">-</span> <span style="color:#008000">min</span>(ORDINAL_DAYS)) <span style="color:#666">/</span> <span style="color:#008000">max</span>(ORDINAL_DAYS <span style="color:#666">-</span> <span style="color:#008000">min</span>(ORDINAL_DAYS))

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">result_type_to_color</span>(result_type: ResultType) <span style="color:#666">-&gt;</span> Tuple[<span style="color:#008000">float</span>, <span style="color:#008000">float</span>, <span style="color:#008000">float</span>]:
    <span style="color:#008000;font-weight:bold">if</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>NOT_MENINGITIS:
        <span style="color:#008000;font-weight:bold">return</span> (<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0.7</span>)
    <span style="color:#008000;font-weight:bold">elif</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>BACTERIAL:
        <span style="color:#008000;font-weight:bold">return</span> (<span style="color:#666">0</span>, <span style="color:#666">0.8</span>, <span style="color:#666">0.8</span>)
    <span style="color:#008000;font-weight:bold">elif</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>VIRAL:
        <span style="color:#008000;font-weight:bold">return</span> (<span style="color:#666">0.33</span>, <span style="color:#666">0.8</span>, <span style="color:#666">0.8</span>)
    <span style="color:#008000;font-weight:bold">else</span>:
        <span style="color:#008000;font-weight:bold">return</span> (<span style="color:#666">0.66</span>, <span style="color:#666">0.8</span>, <span style="color:#666">0.8</span>)

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">make_colors</span>(cases: pd<span style="color:#666">.</span>DataFrame) <span style="color:#666">-&gt;</span> List[Tuple[<span style="color:#008000">float</span>, <span style="color:#008000">float</span>, <span style="color:#008000">float</span>]]:
    <span style="color:#008000;font-weight:bold">return</span> [
        colors<span style="color:#666">.</span>hsv_to_rgb(result_type_to_color(result))
        <span style="color:#008000;font-weight:bold">for</span> result <span style="color:#a2f;font-weight:bold">in</span> cases[<span style="color:#ba2121">&#34;classification&#34;</span>]
    ]

MIN_LAT, MAX_LAT <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>latitude<span style="color:#666">.</span>min(), DATAFRAME<span style="color:#666">.</span>latitude<span style="color:#666">.</span>max()
MIN_LONG, MAX_LONG <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>longitude<span style="color:#666">.</span>min(), DATAFRAME<span style="color:#666">.</span>longitude<span style="color:#666">.</span>max()

DATE_MIN <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>date<span style="color:#666">.</span>min()
DATE_MAX <span style="color:#666">=</span> DATAFRAME<span style="color:#666">.</span>date<span style="color:#666">.</span>max()

current_date <span style="color:#666">=</span> DATE_MIN

<span style="color:#008000;font-weight:bold">for</span> i_day <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">0</span>, (DATE_MAX <span style="color:#666">-</span> DATE_MIN)<span style="color:#666">.</span>days, <span style="color:#666">7</span>):
    last_date <span style="color:#666">=</span> current_date
    current_date <span style="color:#666">=</span> DATE_MIN <span style="color:#666">+</span> timedelta(days<span style="color:#666">=</span>i_day)
    cases_today <span style="color:#666">=</span> DATAFRAME[(DATAFRAME<span style="color:#666">.</span>date <span style="color:#666">&gt;</span> last_date) <span style="color:#666">&amp;</span> (DATAFRAME<span style="color:#666">.</span>date <span style="color:#666">&lt;=</span> current_date)]
    cases_prior <span style="color:#666">=</span> DATAFRAME[DATAFRAME<span style="color:#666">.</span>date <span style="color:#666">&lt;=</span> last_date]
    fig, ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots()
    ax<span style="color:#666">.</span>scatter(
        cases_today[<span style="color:#ba2121">&#39;longitude&#39;</span>],
        cases_today[<span style="color:#ba2121">&#39;latitude&#39;</span>],
        c<span style="color:#666">=</span>make_colors(cases_today),
        s<span style="color:#666">=</span><span style="color:#666">3</span>,
    )
    ax<span style="color:#666">.</span>scatter(
        cases_prior[<span style="color:#ba2121">&#39;longitude&#39;</span>],
        cases_prior[<span style="color:#ba2121">&#39;latitude&#39;</span>],
        c<span style="color:#666">=</span>make_colors(cases_prior),
        s<span style="color:#666">=</span><span style="color:#666">2</span>,
        alpha<span style="color:#666">=</span><span style="color:#666">0.2</span>
    )
    ax<span style="color:#666">.</span>set_xlim((MIN_LONG, MAX_LONG))
    ax<span style="color:#666">.</span>set_ylim((MIN_LAT, MAX_LAT))
    plt<span style="color:#666">.</span>ylabel(<span style="color:#ba2121">&#39;Latitude&#39;</span>)
    plt<span style="color:#666">.</span>xlabel(<span style="color:#ba2121">&#39;Longitude&#39;</span>)
    plt<span style="color:#666">.</span>title(f<span style="color:#ba2121">&#39;Meningitis Cases until Date {current_date:%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">}&#39;</span>)
    plt<span style="color:#666">.</span>tight_layout()
    plt<span style="color:#666">.</span>savefig(f<span style="color:#ba2121">&#39;mapping-meningitis/{current_date:%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">}.png&#39;</span>)
    plt<span style="color:#666">.</span>close()

frame_filenames <span style="color:#666">=</span> glob<span style="color:#666">.</span>glob(<span style="color:#ba2121">&#39;./mapping-meningitis/*.png&#39;</span>)
frame_filenames<span style="color:#666">.</span>sort()
frames <span style="color:#666">=</span> [PIL<span style="color:#666">.</span>Image<span style="color:#666">.</span>open(<span style="color:#008000">file</span>) <span style="color:#008000;font-weight:bold">for</span> <span style="color:#008000">file</span> <span style="color:#a2f;font-weight:bold">in</span> frame_filenames]

frames[<span style="color:#666">0</span>]<span style="color:#666">.</span>save(
    <span style="color:#ba2121">&#39;mapping-meningitis.gif&#39;</span>,
    format<span style="color:#666">=</span><span style="color:#ba2121">&#39;GIF&#39;</span>,
    append_images<span style="color:#666">=</span>[frames[<span style="color:#666">0</span>]]<span style="color:#666">*</span><span style="color:#666">10</span> <span style="color:#666">+</span> frames <span style="color:#666">+</span> [frames[<span style="color:#666">-</span><span style="color:#666">1</span>]] <span style="color:#666">*</span> <span style="color:#666">10</span>,
    save_all<span style="color:#666">=</span>True,
    duration<span style="color:#666">=</span><span style="color:#666">100</span>,
    loop<span style="color:#666">=</span><span style="color:#666">0</span>
)</code></pre></div>
</div>
</details>
<h3 id="headline-3">
Data Generation
</h3>
<details><summary>Click here to show the data generation code.</summary>
<p>
We can generate this data using simple string templating and functions provided
by various libraries to produce either random numbers of random choices.
</p>
<p>
We will:
</p>
<ol>
<li>
<p>
Represent a CSF result for a particular sample belonging to a particular
patient as a Python <code class="verbatim">dataclass</code>,
</p>
</li>
<li>
<p>
Write functions to randomly generate a CSF result based on whether we want
the result to reflect a bacterial, viral or fungal/TB meningitis,
</p>
</li>
<li>
<p>
Generate the data by randomly selecting what type of result to generate with
parameters based on location and time.
</p>
</li>
</ol>
<p>
First, we enumerate constants to express the non-numerical results from a CSF
report.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">enum</span> <span style="color:#008000;font-weight:bold">import</span> Enum

<span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">Appearance</span>(Enum):
    <span style="color:#ba2121">&#34;&#34;&#34; Enumerates possible macroscopic appearances of CSF.
</span><span style="color:#ba2121">    &#34;&#34;&#34;</span>
    CLEAR <span style="color:#666">=</span> <span style="color:#ba2121">&#34;Clear and colourless.&#34;</span>
    TURBID <span style="color:#666">=</span> <span style="color:#ba2121">&#34;Turbid.&#34;</span>
    XANTHOCHROMIC <span style="color:#666">=</span> <span style="color:#ba2121">&#34;Xanthrochromic.&#34;</span>
    BLOODY <span style="color:#666">=</span> <span style="color:#ba2121">&#34;Grossly bloody.&#34;</span>

<span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">Predominance</span>(Enum):
    <span style="color:#ba2121">&#34;&#34;&#34; Enumerates possible cell predominances of CSF.
</span><span style="color:#ba2121">    &#34;&#34;&#34;</span>
    NEITHER <span style="color:#666">=</span> <span style="color:#ba2121">&#34;predominance unspecified&#34;</span>
    NEUTROPHILS <span style="color:#666">=</span> <span style="color:#ba2121">&#34;polymorphonuclear predominance&#34;</span>
    LYMPHOCYTES <span style="color:#666">=</span> <span style="color:#ba2121">&#34;lymphocytic predominance&#34;</span></code></pre></div>
</div>
<p>
Next, we create <code class="verbatim">dataclass</code> for the CSF result for convenience. We can simply
instantiate a new instance of this dataclass for each result, and call a method
<code class="verbatim">to_string</code> to convert an instance to a string representation of the report. As
a reference, we found <a href="https://www.rcpa.edu.au/Manuals/RCPA-Manual/Pathology-Tests/C/Cerebrospinal-fluid-examination">The RCPA Manual</a> a good resource on what the CSF result
should look like.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">datetime</span> <span style="color:#008000;font-weight:bold">import</span> datetime
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">dataclasses</span> <span style="color:#008000;font-weight:bold">import</span> dataclass
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">typing</span> <span style="color:#008000;font-weight:bold">import</span> Tuple

<span style="color:#a2f">@dataclass</span>
<span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">CSFResult</span>:
    <span style="color:#ba2121">&#34;&#34;&#34; Dataclass to hold cerebrospinal fluid results.
</span><span style="color:#ba2121">    &#34;&#34;&#34;</span>

    patient_id: <span style="color:#008000">int</span>
    sample_datetime: datetime
    location: Tuple[<span style="color:#008000">float</span>, <span style="color:#008000">float</span>] <span style="color:#408080;font-style:italic"># latitude, longitude</span>
    appearance: Appearance
    cell_count: <span style="color:#008000">float</span> <span style="color:#408080;font-style:italic"># Units e6/L</span>
    predominance: Predominance
    glucose: <span style="color:#008000">float</span> <span style="color:#408080;font-style:italic"># Units mmol/L</span>
    lactate: <span style="color:#008000">float</span> <span style="color:#408080;font-style:italic"># Units mmol/L</span>
    protein: <span style="color:#008000">float</span> <span style="color:#408080;font-style:italic"># Units g/L</span>

    <span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">to_string</span>(self) <span style="color:#666">-&gt;</span> <span style="color:#008000">str</span>:
        <span style="color:#ba2121">&#34;&#34;&#34;
</span><span style="color:#ba2121">        Converts a CSF result into a string.
</span><span style="color:#ba2121">        &#34;&#34;&#34;</span>

        result_string <span style="color:#666">=</span> (
            f<span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">PATIENT ID: {self.patient_id:06}</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;LOCATION: ({&#39;,&#39;.join(map(lambda x: f&#39;{x:.6f}&#39;, self.location))})</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;SAMPLE TIMESTAMP: {self.sample_datetime:%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">}</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;RESULTS:</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;{self.appearance.value}</span><span style="color:#b62;font-weight:bold">\n\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;CELL COUNT:  {self.cell_count:.2f}  x 10^6 / L ({self.predominance.value})</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;GLUCOSE:     {self.glucose:.2f}  mmol/L</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;LACTATE:     {self.lactate:.2f}  mmol/L</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
            f<span style="color:#ba2121">&#34;PROTEIN:     {self.protein:.2f}  g/L</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>
        )

        <span style="color:#008000;font-weight:bold">return</span> result_string</code></pre></div>
</div>
<p>
Next, we will write a function to generate a random result based on whether we
want the result to be most suggestive of a bacterial, viral or fungal infection.
For simplicity, we will specify the differences between these infections as
purely based on the CSF result; in practice, CSF results must always be
interpreted in the context of the whole patient and other clinical information.
</p>
<p>
First, we enumerate the types of results.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#008000;font-weight:bold">class</span> <span style="color:#00f;font-weight:bold">ResultType</span>(Enum):
    <span style="color:#ba2121">&#34;&#34;&#34; Enumerates the possible CSF result types.
</span><span style="color:#ba2121">    &#34;&#34;&#34;</span>
    NORMAL <span style="color:#666">=</span> <span style="color:#666">0</span>
    BACTERIAL <span style="color:#666">=</span> <span style="color:#666">1</span>
    VIRAL <span style="color:#666">=</span> <span style="color:#666">2</span>
    FUNGAL <span style="color:#666">=</span> <span style="color:#666">3</span></code></pre></div>
</div>
<p>
Next, we specify a generation function which takes a <code class="verbatim">ResultType</code> and returns a
<code class="verbatim">CSFResult</code> instance which reflects it.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">random</span> <span style="color:#008000;font-weight:bold">import</span> choices, gauss, uniform

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">generate_result</span>(result_type: ResultType, <span style="color:#666">**</span>kwargs) <span style="color:#666">-&gt;</span> CSFResult:
    <span style="color:#ba2121">&#34;&#34;&#34; Generates a CSFResult instance based on result_type.
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">    Most of the generation is defining parameters for random selection.
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">    For randomly selecting Appearance, the order of defining weights is:
</span><span style="color:#ba2121">        [CLEAR, TURBID, XANTHROCHROMIC, BLOODY]
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">    For randomly selecting Predominance, the order of defining weights is:
</span><span style="color:#ba2121">        [NEITHER, NEUTROPHILS, LYMPHOCYTES]
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">    Parameters
</span><span style="color:#ba2121">    ----------
</span><span style="color:#ba2121">    result_type: ResultType
</span><span style="color:#ba2121">        One of ResultType.BACTERIAL, ResultType.VIRAL or ResultType.FUNGAL.
</span><span style="color:#ba2121">    ,**kwargs
</span><span style="color:#ba2121">        Extra kwargs passed to CSFResult constructor. It should include
</span><span style="color:#ba2121">        patient_id, sample_datetime and location.
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">
</span><span style="color:#ba2121">    &#34;&#34;&#34;</span>
    <span style="color:#008000;font-weight:bold">if</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>NORMAL:
        result <span style="color:#666">=</span> CSFResult(
            appearance<span style="color:#666">=</span>Appearance<span style="color:#666">.</span>CLEAR,
            cell_count<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.1</span>, gauss(<span style="color:#666">2.5</span>, <span style="color:#666">2.5</span>)),
            predominance<span style="color:#666">=</span>Predominance<span style="color:#666">.</span>NEITHER,
            glucose<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">2.5</span>, gauss(<span style="color:#666">3.6</span>, <span style="color:#666">0.4</span>)),
            lactate<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">1.0</span>, gauss(<span style="color:#666">2.0</span>, <span style="color:#666">0.4</span>)),
            protein<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.1</span>, gauss(<span style="color:#666">0.3</span>, <span style="color:#666">0.1</span>)),
            <span style="color:#666">**</span>kwargs,
        )
    <span style="color:#008000;font-weight:bold">elif</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>BACTERIAL:
        result <span style="color:#666">=</span> CSFResult(
            appearance<span style="color:#666">=</span>choices(<span style="color:#008000">list</span>(Appearance), [<span style="color:#666">1</span>, <span style="color:#666">10</span>, <span style="color:#666">0.01</span>, <span style="color:#666">0.1</span>])[<span style="color:#666">0</span>],
            cell_count<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">10</span>, gauss(<span style="color:#666">5000</span>, <span style="color:#666">4000</span>)),
            predominance<span style="color:#666">=</span>Predominance<span style="color:#666">.</span>NEUTROPHILS,
            glucose<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.1</span>, gauss(<span style="color:#666">1.0</span>, <span style="color:#666">0.5</span>)),
            lactate<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">1.2</span>, gauss(<span style="color:#666">3.5</span>, <span style="color:#666">1.0</span>)),
            protein<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.2</span>, gauss(<span style="color:#666">2.5</span>, <span style="color:#666">1.0</span>)),
            <span style="color:#666">**</span>kwargs,
        )
    <span style="color:#008000;font-weight:bold">elif</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>VIRAL:
        result <span style="color:#666">=</span> CSFResult(
            appearance<span style="color:#666">=</span>choices(<span style="color:#008000">list</span>(Appearance), [<span style="color:#666">4</span>, <span style="color:#666">6</span>, <span style="color:#666">0.01</span>, <span style="color:#666">0.1</span>])[<span style="color:#666">0</span>],
            cell_count<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">10</span>, gauss(<span style="color:#666">100</span>, <span style="color:#666">50</span>)),
            predominance<span style="color:#666">=</span>Predominance<span style="color:#666">.</span>LYMPHOCYTES,
            glucose<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">2.5</span>, gauss(<span style="color:#666">3.6</span>, <span style="color:#666">0.4</span>)),
            lactate<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">1.0</span>, gauss(<span style="color:#666">2.0</span>, <span style="color:#666">0.4</span>)),
            protein<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.1</span>, gauss(<span style="color:#666">0.3</span>, <span style="color:#666">0.1</span>)),
            <span style="color:#666">**</span>kwargs,
        )
    <span style="color:#008000;font-weight:bold">elif</span> result_type <span style="color:#666">==</span> ResultType<span style="color:#666">.</span>FUNGAL:
        result <span style="color:#666">=</span> CSFResult(
            appearance<span style="color:#666">=</span>choices(<span style="color:#008000">list</span>(Appearance), [<span style="color:#666">1</span>, <span style="color:#666">10</span>, <span style="color:#666">0.01</span>, <span style="color:#666">0.1</span>])[<span style="color:#666">0</span>],
            cell_count<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">10</span>, gauss(<span style="color:#666">400</span>, <span style="color:#666">300</span>)),
            predominance<span style="color:#666">=</span>Predominance<span style="color:#666">.</span>LYMPHOCYTES,
            glucose<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.1</span>, gauss(<span style="color:#666">1.0</span>, <span style="color:#666">0.5</span>)),
            lactate<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">1.2</span>, gauss(<span style="color:#666">2.5</span>, <span style="color:#666">2.0</span>)),
            protein<span style="color:#666">=</span><span style="color:#008000">max</span>(<span style="color:#666">0.2</span>, gauss(<span style="color:#666">1.5</span>, <span style="color:#666">1.0</span>)),
            <span style="color:#666">**</span>kwargs,
        )
    <span style="color:#008000;font-weight:bold">return</span> result</code></pre></div>
</div>
<p>
We next specify a dataset generation function which will generate a list of 1000
patient IDs, locations, sample datetimes and result types. We will define a
central coordinate from which bacterial cases will originate from, and intermix
them with non-related cases.
</p>
<p>
For simplicity, we will define coordinates using floating point numbers; this
isn&#39;t a particularly good system though for &#34;real-life&#34; dealings with latitude
and longitude where the precision of floating point numbers cannot be
guaranteed. For simpliciy, we&#39;ve also made the
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">datetime</span> <span style="color:#008000;font-weight:bold">import</span> timedelta
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">random</span> <span style="color:#008000;font-weight:bold">import</span> sample
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">typing</span> <span style="color:#008000;font-weight:bold">import</span> Tuple
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>

<span style="color:#408080;font-style:italic"># Define constant parameters</span>
SOURCE_LAT, SOURCE_LONG <span style="color:#666">=</span> (<span style="color:#666">-</span><span style="color:#666">37.8180</span>, <span style="color:#666">144.9691</span>)
SPREAD <span style="color:#666">=</span> <span style="color:#666">0.003</span> <span style="color:#408080;font-style:italic"># per day</span>
DURATION <span style="color:#666">=</span> <span style="color:#666">168</span> <span style="color:#408080;font-style:italic"># in days, i.e. 24 weeks</span>
NUM_SAMPLES <span style="color:#666">=</span> <span style="color:#666">1000</span>
START_DATE <span style="color:#666">=</span> datetime(<span style="color:#666">2020</span>, <span style="color:#666">3</span>, <span style="color:#666">1</span>)
NUM_ABERRANT <span style="color:#666">=</span> <span style="color:#666">300</span> <span style="color:#408080;font-style:italic"># number of &#34;aberrant&#34; cases</span>
BOUND_LAT, BOUND_LONG <span style="color:#666">=</span> (<span style="color:#666">1.0</span>, <span style="color:#666">1.0</span>) <span style="color:#408080;font-style:italic"># bounds of map</span>

<span style="color:#408080;font-style:italic"># Generate random time deltas from day 0</span>
day_deltas <span style="color:#666">=</span> choices(<span style="color:#008000">range</span>(DURATION), k<span style="color:#666">=</span>NUM_SAMPLES)

<span style="color:#408080;font-style:italic"># Create dates from day_deltas (randomly ordered)</span>
dates <span style="color:#666">=</span> [START_DATE <span style="color:#666">+</span> timedelta(days<span style="color:#666">=</span>day_delta) <span style="color:#008000;font-weight:bold">for</span> day_delta <span style="color:#a2f;font-weight:bold">in</span> day_deltas]

<span style="color:#408080;font-style:italic"># Extract the first 600 as &#34;aberrant&#34; cases and make locations</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">make_spread</span>(delta: <span style="color:#008000">int</span>) <span style="color:#666">-&gt;</span> Tuple[<span style="color:#008000">float</span>, <span style="color:#008000">float</span>]:
    radius <span style="color:#666">=</span> gauss(delta, <span style="color:#666">2</span><span style="color:#666">*</span>SPREAD) <span style="color:#666">*</span> SPREAD
    angle <span style="color:#666">=</span> uniform(<span style="color:#666">0</span>, <span style="color:#666">2</span> <span style="color:#666">*</span> np<span style="color:#666">.</span>pi)
    new_lat <span style="color:#666">=</span> SOURCE_LAT <span style="color:#666">+</span> radius <span style="color:#666">*</span> np<span style="color:#666">.</span>sin(angle)
    new_long <span style="color:#666">=</span> SOURCE_LONG <span style="color:#666">+</span> radius <span style="color:#666">*</span> np<span style="color:#666">.</span>cos(angle)
    <span style="color:#008000;font-weight:bold">return</span> (new_lat, new_long)

locations_aberrant <span style="color:#666">=</span> [
    make_spread(delta)
    <span style="color:#008000;font-weight:bold">for</span> delta <span style="color:#a2f;font-weight:bold">in</span> day_deltas[:NUM_ABERRANT]
]

locations_other <span style="color:#666">=</span> [
    (SOURCE_LAT <span style="color:#666">+</span> uniform(<span style="color:#666">-</span>BOUND_LAT, BOUND_LAT) <span style="color:#666">-</span> <span style="color:#666">0.1</span>,
     SOURCE_LONG <span style="color:#666">+</span> uniform(<span style="color:#666">-</span>BOUND_LONG, BOUND_LONG) <span style="color:#666">-</span> <span style="color:#666">0.3</span>)
    <span style="color:#008000;font-weight:bold">for</span> _ <span style="color:#a2f;font-weight:bold">in</span> day_deltas[NUM_ABERRANT:]
]
locations <span style="color:#666">=</span> locations_aberrant <span style="color:#666">+</span> locations_other

<span style="color:#408080;font-style:italic"># Make result types</span>
result_types_aberrant <span style="color:#666">=</span> [ResultType<span style="color:#666">.</span>BACTERIAL] <span style="color:#666">*</span> NUM_ABERRANT
result_types_other <span style="color:#666">=</span> choices(<span style="color:#008000">list</span>(ResultType), [<span style="color:#666">1</span>, <span style="color:#666">3</span>, <span style="color:#666">1</span>, <span style="color:#666">0.5</span>], k<span style="color:#666">=</span>NUM_SAMPLES<span style="color:#666">-</span>NUM_ABERRANT)
result_types <span style="color:#666">=</span> result_types_aberrant <span style="color:#666">+</span> result_types_other

<span style="color:#408080;font-style:italic"># Generate random 6-digit patients IDs</span>
patient_ids <span style="color:#666">=</span> sample(<span style="color:#008000">range</span>(<span style="color:#666">999999</span>), k<span style="color:#666">=</span>NUM_SAMPLES)

<span style="color:#408080;font-style:italic"># Generate all results</span>
results <span style="color:#666">=</span> [
    generate_result(
        result_type<span style="color:#666">=</span>result_type,
        patient_id<span style="color:#666">=</span>patient_id,
        location<span style="color:#666">=</span>location,
        sample_datetime<span style="color:#666">=</span>date,
    )
    <span style="color:#008000;font-weight:bold">for</span> result_type, patient_id, location, date
    <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">zip</span>(result_types, patient_ids, locations, dates)
]</code></pre></div>
</div>
<p>
Finally, we need to shuffle the results, join all the results into a single
string and then save it to a file.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">random</span> <span style="color:#008000;font-weight:bold">import</span> shuffle

<span style="color:#408080;font-style:italic"># Shuffle results in-place</span>
shuffle(results)

<span style="color:#408080;font-style:italic"># Define the separator</span>
separator <span style="color:#666">=</span> <span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span> <span style="color:#666">+</span> <span style="color:#ba2121">&#34;-&#34;</span> <span style="color:#666">*</span> <span style="color:#666">80</span> <span style="color:#666">+</span> <span style="color:#ba2121">&#34;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span>

<span style="color:#408080;font-style:italic"># Join result strings with separator</span>
output <span style="color:#666">=</span> separator<span style="color:#666">.</span>join(result<span style="color:#666">.</span>to_string() <span style="color:#008000;font-weight:bold">for</span> result <span style="color:#a2f;font-weight:bold">in</span> results)

<span style="color:#408080;font-style:italic"># Save the output to a file</span>
FILENAME <span style="color:#666">=</span> <span style="color:#ba2121">&#34;input-mapping-meningitis.txt&#34;</span>
<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(FILENAME, <span style="color:#ba2121">&#39;w+&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> outfile:
    outfile<span style="color:#666">.</span>write(output)</code></pre></div>
</div>
<p>
This generates the input data and saves it into the file
<code class="verbatim">input_mapping_meningitis.txt</code>.
</p>
</details>

            </section>

        </article>
    </section>

</section>


        </main>

        <footer><footer>
</footer>
</footer>

    </body>
</html>
