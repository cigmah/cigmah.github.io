
<!DOCTYPE html>
<html><head>
    
    
    <title> CIGMAH - Transfusion Tracing </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="">
    <meta name="theme-color" content="#000000" />
    <link rel="icon" href="https://cigmah.org/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cigmah.org/js/toggles.js"></script>
    <link type="text/css" rel="stylesheet" href=https://cigmah.org/sass/main.css>
    <link rel="canonical" href="https://cigmah.org/events/2019_text_processing/tute-01-transfusion-tracing/transfusion-tracing/">
</head>
<body>
        <header>

            <nav id="nav-menu-toggle" onClick="toggleNav()">
                <div id="menu-text">â˜°</div>
                <div id="cigmah-brand">
                    <div id="cigmah-icon">
                        <img src="https://cigmah.org/img/cigmah-icon.png">
                    </div>
                    <div id="cigmah-text">
                        CIGMAH
                    </div>
                </div>
            </nav>

            <nav id="nav-bar">

<ul id="nav-link-list" onClick="()">

    <li
        class="nav-link-list-item "
    >
        <a
            class="nav-link-list-link "
            id="nav-cigmah-link"
            href=https://cigmah.org/
        >
            <img id="nav-cigmah-link-icon" src="/img/cigmah-icon-small.png">
            <div>CIGMAH</div>
        </a>
    </li>

  
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/about/
        >
            About
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/events/
        >
            Events
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/tools/
        >
            Tools
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/resources/
        >
            Resources
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/blog/
        >
            Blog
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/contact/
        >
            Contact
        </a>
    </li>
    

    <li
        class="nav-link-list-item"
        id="nav-right-item"
        >
        <a
            href="https://aorta.cigmah.org"
            id="nav-aorta-link"
            class="nav-link-list-link"
        >
            <img id="nav-aorta-link-icon" src="/img/aorta-icon.png">
            <div id="nav-aorta-link">AORTA</div>
        </a>
    </li>
</ul>
</nav>

        </header>

        <main>



<section class="normal-page">
    <article id="side-navigation">
        <article id="toggle-side-navigation-container">

            
            <a href="https://cigmah.org/events/2019_text_processing/" id="back"> &lt;&lt; </a>
            

            <button id="toggle-side-navigation" onClick="toggleSideNav()">Show Articles</button>

            
            <a href="https://cigmah.org/events/2019_text_processing/tute-01-mood-diary/mood-diary/" id="next"> &gt;&gt; </a>
            

        </article>

        <ul id="side-navigation-list">

            
            <li class="side-navigation-parent">
                <a href="https://cigmah.org/events/">Events</a>
            </li>
            


            <li class="side-navigation-section">
                <a href="https://cigmah.org/events/2019_text_processing/">
                    Night 1: Text Processing
                </a>
            </li>

            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-contraindicated/contraindicated/">Contraindicated</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-mapping-meningitis/mapping-meningitis/">Mapping Meningitis</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-mood-diary/mood-diary/">Mood Diary</a>
            </li>
            
            <li
                class="side-navigation-item  active "
            >
                <a href="https://cigmah.org/events/2019_text_processing/tute-01-transfusion-tracing/transfusion-tracing/">Transfusion Tracing</a>
            </li>
            

        </ul>

    </article>

    <section id="container">

        <article id="content">
            <header id="content-header">
            <h1 id="content-title"> Transfusion Tracing </h1>

            
                <div id="subtitle">
                    <div>  </div>
                </div>
            

            </div>

            </header>

            <section id="content-body">
                
<h2 id="headline-1">
Problem
</h2>
<p>
Your hospital&#39;s infectious diseases department has queried two recent diagnoses
of Hepatitis C in patients who have both received blood traced to the same blood
donor. While the transmission of blood-borne infections through blood
transfusions is <em>exceedingly</em> rare in the modern age, your hospital has raised
an inquiry for due caution.
</p>
<p>
You have been provided with trimmed, deidentified transfusion logs over
6 months (from 1st January 2020 to 30th June 2020) in the following format
(first five lines):
</p>
<div class="src src-text">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">2020-01-01    D012311    095703
2020-01-01    D041530    028619
2020-01-01    D007809    026117
2020-01-01    D037810    021170
2020-01-01    D099727    042349</code></pre></div>
</div>
<p>
You have 50000 lines in your input. Each log begins with a date of transfusion,
a donor ID (&#34;D&#34; followed by six digits) and the ID of the patient who received a
blood product traced to that donor. A single donor ID and patient ID correspond
to a single donor/patient; some patients receive more than one blood transfusion
and some donors contribute more than one blood product that is transfused, and
therefore each may be repeated one or more times in the logs.
</p>
<p>
You have also been provided with all the patients in this list of transfusion
logs who have been diagnosed with Hepatitis C (though not necessarily as a
result of transfusion) in 2020 in the following format (first five lines):
</p>
<div class="src src-text">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">2020-02-15    062923
2020-02-24    099772
2020-03-09    085550
2020-03-13    051412
2020-03-14    055593</code></pre></div>
</div>
<p>
The first column lists the date of diagnosis, and the second lists the patient
ID of the patient diagnosed, which matches with the patient ID in the
transfusion logs. You may assume any patient not in this list was not diagnosed
with Hepatitis C.
</p>
<p>
<strong>Your task</strong> is to:
</p>
<ol>
<li>
<p>
Process the transfusion logs and list of Hepatitis C diagnoses into a
workable data format.
</p>
</li>
<li>
<p>
Join the data and determine the ID of the source donor from whom patients are most
likely to have received a transfusion prior to being diagnosed with Hepatitis C.
</p>
</li>
</ol>
<p>
<a href="../input-transfusion-tracing-transfusions.txt">Click here to download the log of transfusions (1,612KB, .txt)</a>
</p>
<p>
<a href="../input-transfusion-tracing-infections.txt">Click here to download the list of Hepatitis C diagnoses (2KB, .txt).</a>
</p>
<h2 id="headline-2">
Solution
</h2>
<details><summary>Click here to show the answer.</summary>
<p>
The donor ID from which patients with Hepatitis C were most likely to have
received a transfusion product from is <strong>D086725</strong> (six patients received a
transfusion product from this donor prior to being diagnosed, versus the next
most common with two patients).
</p>
</details>
<details><summary>Click here to show the solution.</summary>
<blockquote>
<p>
We haven&#39;t explained this step-by-step in full yet, but here&#39;s the solution as
it stands at the moment. A more detailed explanation will appear shortly.
</p>
</blockquote>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(<span style="color:#ba2121">&#39;input-transfusion-tracing-infections.txt&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> infile:
    RAW_INFECTIONS <span style="color:#666">=</span> infile<span style="color:#666">.</span>readlines()
<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(<span style="color:#ba2121">&#39;input-transfusion-tracing-transfusions.txt&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> infile:
    RAW_TRANSFUSIONS <span style="color:#666">=</span> infile<span style="color:#666">.</span>readlines()

<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">re</span>
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">typing</span> <span style="color:#008000;font-weight:bold">import</span> List
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">datetime</span> <span style="color:#008000;font-weight:bold">import</span> datetime

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">procdate</span>(row):
    datetime_string, <span style="color:#666">*</span>rest <span style="color:#666">=</span> row
    <span style="color:#008000;font-weight:bold">return</span> [ datetime<span style="color:#666">.</span>strptime(datetime_string, <span style="color:#ba2121">&#39;%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">&#39;</span>), <span style="color:#666">*</span>rest ]

INFECTIONS <span style="color:#666">=</span> [procdate(line<span style="color:#666">.</span>split()) <span style="color:#008000;font-weight:bold">for</span> line <span style="color:#a2f;font-weight:bold">in</span> RAW_INFECTIONS]
TRANSFUSIONS <span style="color:#666">=</span> [procdate(line<span style="color:#666">.</span>split()) <span style="color:#008000;font-weight:bold">for</span> line <span style="color:#a2f;font-weight:bold">in</span> RAW_TRANSFUSIONS]

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">received_prior</span>(infection_data):
    <span style="color:#008000;font-weight:bold">return</span> <span style="color:#008000">set</span>([
        transfusion[<span style="color:#666">1</span>] <span style="color:#008000;font-weight:bold">for</span> transfusion <span style="color:#a2f;font-weight:bold">in</span> TRANSFUSIONS
        <span style="color:#008000;font-weight:bold">if</span> (transfusion[<span style="color:#666">0</span>] <span style="color:#666">&lt;</span> infection_data[<span style="color:#666">0</span>] <span style="color:#a2f;font-weight:bold">and</span> transfusion[<span style="color:#666">2</span>] <span style="color:#666">==</span> infection_data[<span style="color:#666">1</span>])
    ])

POSSIBLE_DONORS <span style="color:#666">=</span> [ received_prior(infection) <span style="color:#008000;font-weight:bold">for</span> infection <span style="color:#a2f;font-weight:bold">in</span> INFECTIONS ]

<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">collections</span> <span style="color:#008000;font-weight:bold">import</span> Counter

COUNTS <span style="color:#666">=</span> Counter([
    donor
    <span style="color:#008000;font-weight:bold">for</span> donor_list <span style="color:#a2f;font-weight:bold">in</span> POSSIBLE_DONORS
    <span style="color:#008000;font-weight:bold">for</span> donor <span style="color:#a2f;font-weight:bold">in</span> donor_list
])

<span style="color:#008000;font-weight:bold">print</span>(COUNTS<span style="color:#666">.</span>most_common()[:<span style="color:#666">5</span>])</code></pre></div>
</div>
</details>
<h3 id="headline-3">
Data Generation
</h3>
<details><summary>Click here to show the data generation code.</summary>
<p>
We will define 5000 patients and 10000 transfusion events involving 1000 unique
donor IDs.
</p>
<p>
First, we initialise lists of patient IDs and donor IDs.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">random</span> <span style="color:#008000;font-weight:bold">import</span> choices

NUM_PATIENTS <span style="color:#666">=</span> <span style="color:#666">20000</span>
NUM_TRANSFUSIONS <span style="color:#666">=</span> <span style="color:#666">50000</span>
NUM_DONORS <span style="color:#666">=</span> <span style="color:#666">5000</span>

PATIENT_IDS <span style="color:#666">=</span> [<span style="color:#ba2121">&#39;{0:06d}&#39;</span><span style="color:#666">.</span>format(i) <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> choices(<span style="color:#008000">range</span>(<span style="color:#666">100000</span>), k<span style="color:#666">=</span>NUM_PATIENTS)]
DONOR_IDS <span style="color:#666">=</span> [<span style="color:#ba2121">&#39;D{0:06d}&#39;</span><span style="color:#666">.</span>format(i) <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> choices(<span style="color:#008000">range</span>(<span style="color:#666">100000</span>), k<span style="color:#666">=</span>NUM_DONORS)]</code></pre></div>
</div>
<p>
We will then select one of the donor IDs as the source of infection. The list is
in a random order, so we can just choose the first one.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">CONTAMINATED_ID <span style="color:#666">=</span> DONOR_IDS[<span style="color:#666">0</span>]
<span style="color:#008000;font-weight:bold">print</span>(CONTAMINATED_ID)</code></pre></div>
</div>
<pre class="example">
D086725
</pre>
<p>
Next, we will simulate a series of transfusion events. First, we create a
collection of datetimes - let us make the datetimes between 2020-01-01 and
2020-06-30.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">datetime</span> <span style="color:#008000;font-weight:bold">import</span> datetime, timedelta

START_DATE <span style="color:#666">=</span> datetime(<span style="color:#666">2020</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>)
END_DATE <span style="color:#666">=</span> datetime(<span style="color:#666">2020</span>, <span style="color:#666">6</span>, <span style="color:#666">30</span>)
DURATION <span style="color:#666">=</span> (END_DATE <span style="color:#666">-</span> START_DATE)<span style="color:#666">.</span>days

EVENT_DELTAS <span style="color:#666">=</span> choices(<span style="color:#008000">range</span>(DURATION), k<span style="color:#666">=</span>NUM_TRANSFUSIONS)
EVENT_DELTAS<span style="color:#666">.</span>sort() <span style="color:#408080;font-style:italic"># sort in place</span>
EVENT_DATETIMES <span style="color:#666">=</span> [START_DATE <span style="color:#666">+</span> timedelta(days<span style="color:#666">=</span>d) <span style="color:#008000;font-weight:bold">for</span> d <span style="color:#a2f;font-weight:bold">in</span> EVENT_DELTAS]</code></pre></div>
</div>
<p>
For each event, we will randomly choose a donor ID and a patient ID. For donor
IDs which don&#39;t match the ID of the contaminated product, we will set the
probability of HCV infection to 0.001 (1 in 1000); note that this is <em>much</em> higher
than the actual risk of HCV infection from non-contaminated products + the
actual incidence of HCV (we have set the rate here to accommodate the fact that
we are not producing 100s of thousands of data points). If the ID matches the
contaminated product, we will set the probability to 0.5.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">random</span> <span style="color:#008000;font-weight:bold">import</span> random, randint

infections <span style="color:#666">=</span> []
infected <span style="color:#666">=</span> <span style="color:#008000">set</span>()

SELECTED_DONORS <span style="color:#666">=</span> choices(DONOR_IDS, k<span style="color:#666">=</span>NUM_TRANSFUSIONS)
SELECTED_PATIENTS <span style="color:#666">=</span> choices(PATIENT_IDS, k<span style="color:#666">=</span>NUM_TRANSFUSIONS)

EVENTS <span style="color:#666">=</span> <span style="color:#008000">list</span>(<span style="color:#008000">zip</span>(EVENT_DATETIMES, SELECTED_DONORS, SELECTED_PATIENTS))

<span style="color:#008000;font-weight:bold">for</span> event, donor, patient <span style="color:#a2f;font-weight:bold">in</span> EVENTS:

    <span style="color:#008000;font-weight:bold">if</span> donor <span style="color:#666">==</span> CONTAMINATED_ID:
        chance_of_infection <span style="color:#666">=</span> <span style="color:#666">0.5</span>
    <span style="color:#008000;font-weight:bold">else</span>:
        chance_of_infection <span style="color:#666">=</span> <span style="color:#666">0.001</span>

    <span style="color:#008000;font-weight:bold">if</span> random() <span style="color:#666">&lt;</span> chance_of_infection:
        <span style="color:#008000;font-weight:bold">if</span> patient <span style="color:#a2f;font-weight:bold">not</span> <span style="color:#a2f;font-weight:bold">in</span> infected:
            incubation_period <span style="color:#666">=</span> randint(<span style="color:#666">14</span>, <span style="color:#666">180</span>)
            infections<span style="color:#666">.</span>append((event <span style="color:#666">+</span> timedelta(days<span style="color:#666">=</span>incubation_period), patient))
            infected<span style="color:#666">.</span>add(patient)

<span style="color:#408080;font-style:italic"># Sort infections in-place by discovery time.</span>
infections<span style="color:#666">.</span>sort(key<span style="color:#666">=</span><span style="color:#008000;font-weight:bold">lambda</span> infection: infection[<span style="color:#666">0</span>])</code></pre></div>
</div>
<p>
Finally, we format and save the results.
</p>
<div class="src src-python">
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">typing</span> <span style="color:#008000;font-weight:bold">import</span> Tuple

<span style="color:#408080;font-style:italic"># FORMATTING EVENTS</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">format_event</span>(event: Tuple[datetime, <span style="color:#008000">str</span>, <span style="color:#008000">str</span>]) <span style="color:#666">-&gt;</span> <span style="color:#008000">str</span>:
    formatted <span style="color:#666">=</span> f<span style="color:#ba2121">&#39;{event[0]:%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">}    {event[1]}    {event[2]}&#39;</span>
    <span style="color:#008000;font-weight:bold">return</span> formatted

FORMATTED_EVENTS <span style="color:#666">=</span> [format_event(event) <span style="color:#008000;font-weight:bold">for</span> event <span style="color:#a2f;font-weight:bold">in</span> EVENTS]
SEPARATOR <span style="color:#666">=</span> <span style="color:#ba2121">&#39;</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#39;</span>
EVENT_STRING <span style="color:#666">=</span> SEPARATOR<span style="color:#666">.</span>join(FORMATTED_EVENTS)

<span style="color:#408080;font-style:italic"># FORMATTING INFECTIONS</span>
<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">format_infection</span>(infection: Tuple[datetime, <span style="color:#008000">str</span>]) <span style="color:#666">-&gt;</span> <span style="color:#008000">str</span>:
    formatted <span style="color:#666">=</span> f<span style="color:#ba2121">&#39;{infection[0]:%Y-%m-</span><span style="color:#b68;font-weight:bold">%d</span><span style="color:#ba2121">}    {infection[1]}&#39;</span>
    <span style="color:#008000;font-weight:bold">return</span> formatted

FORMATTED_INFECTIONS <span style="color:#666">=</span> [format_infection(infection) <span style="color:#008000;font-weight:bold">for</span> infection <span style="color:#a2f;font-weight:bold">in</span> infections]
INFECTION_STRING <span style="color:#666">=</span> SEPARATOR<span style="color:#666">.</span>join(FORMATTED_INFECTIONS)

<span style="color:#408080;font-style:italic"># FILE IO</span>
EVENT_FILENAME <span style="color:#666">=</span> <span style="color:#ba2121">&#39;input-transfusion-tracing-transfusions.txt&#39;</span>
INFECTION_FILENAME <span style="color:#666">=</span> <span style="color:#ba2121">&#39;input-transfusion-tracing-infections.txt&#39;</span>

<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(EVENT_FILENAME, <span style="color:#ba2121">&#39;w+&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> outfile:
    outfile<span style="color:#666">.</span>write(EVENT_STRING)

<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(INFECTION_FILENAME, <span style="color:#ba2121">&#39;w+&#39;</span>) <span style="color:#008000;font-weight:bold">as</span> outfile:
    outfile<span style="color:#666">.</span>write(INFECTION_STRING)</code></pre></div>
</div>
</details>

            </section>

        </article>
    </section>

</section>


        </main>

        
        <footer>Contact us at <code> contact at cigmah dot org </code>.
</footer>
        

    </body>
</html>
