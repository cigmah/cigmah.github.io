
<!DOCTYPE html>
<html><head>
    
    
    <title> CIGMAH - Bite Cell Scouting </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="2019 Puzzle Hunt - Puzzle 10C">
    <meta name="theme-color" content="#000000" />
    <link rel="icon" href="https://cigmah.org/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cigmah.org/js/toggles.js"></script>
    <link type="text/css" rel="stylesheet" href=https://cigmah.org/sass/main.css>
    <link rel="canonical" href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle10/">
</head>
<body>
        <header>

            <nav id="nav-menu-toggle" onClick="toggleNav()">
                <div id="menu-text">â˜°</div>
                <div id="cigmah-brand">
                    <div id="cigmah-icon">
                        <img src="https://cigmah.org/img/cigmah-icon.png">
                    </div>
                    <div id="cigmah-text">
                        CIGMAH
                    </div>
                </div>
            </nav>

            <nav id="nav-bar">

<ul id="nav-link-list" onClick="()">

    <li
        class="nav-link-list-item "
    >
        <a
            class="nav-link-list-link "
            id="nav-cigmah-link"
            href=https://cigmah.org/
        >
            <img id="nav-cigmah-link-icon" src="/img/cigmah-icon-small.png">
            <div>CIGMAH</div>
        </a>
    </li>

  
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/about/
        >
            About
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/events/
        >
            Events
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/tools/
        >
            Tools
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/resources/
        >
            Resources
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/blog/
        >
            Blog
        </a>
    </li>
    
    <li
        class="nav-link-list-item "
        >
        <a
            class="nav-link-list-link "
            href=https://cigmah.org/contact/
        >
            Contact
        </a>
    </li>
    

    <li
        class="nav-link-list-item"
        id="nav-right-item"
        >
        <a
            href="https://aorta.cigmah.org"
            id="nav-aorta-link"
            class="nav-link-list-link"
        >
            <img id="nav-aorta-link-icon" src="/img/aorta-icon.png">
            <div id="nav-aorta-link">AORTA</div>
        </a>
    </li>
</ul>
</nav>

        </header>

        <main>



<section class="normal-page">
    <article id="side-navigation">
        <article id="toggle-side-navigation-container">

            
            <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle09/puzzle09/" id="back"> &lt;&lt; </a>
            

            <button id="toggle-side-navigation" onClick="toggleSideNav()">Show Articles</button>

            
            <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle11/puzzle11/" id="next"> &gt;&gt; </a>
            

        </article>

        <ul id="side-navigation-list">

            
            <li class="side-navigation-parent">
                <a href="https://cigmah.org/events/">Events</a>
            </li>
            


            <li class="side-navigation-section">
                <a href="https://cigmah.org/events/2019_puzzlehunt/">
                    2019 Puzzle Hunt
                </a>
            </li>

            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle01/">Lost in a Library</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle02/">Metabolic Mayhem</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle03/">Combo Catcher</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle04/">Troubled Test</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle05/">Out of Sync</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle06/">While You&#39;re Waiting</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle07/">Infectious Network</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle08/puzzle08/">Tarsal Tumble</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle09/puzzle09/">Fundal Flow</a>
            </li>
            
            <li
                class="side-navigation-item  active "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle10/">Bite Cell Scouting</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle11/puzzle11/">NeuroLogic</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle12/">Reschedule All</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle13/puzzle13/">Allele Inference</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle14/puzzle14/">Base in Balance</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle15/puzzle15/">Worst Offender</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle16/puzzle16/">STI Bugs&#39;n&#39;Drugs</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle17/puzzle17/">What Dipstick?</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle18/puzzle18/">Peak Flow Diary</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle19/puzzle19/">HPV Profiling</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle20/puzzle20/">Code Broadcast</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle21/puzzle21/">Genetic Thrift</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle22/puzzle22/">Neural Decoding</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle23/puzzle23/">Run! (Preclinical)</a>
            </li>
            
            <li
                class="side-navigation-item "
            >
                <a href="https://cigmah.org/events/2019_puzzlehunt/puzzles/cgmnt-puzzle24/puzzle24/">Run! (Clinical)</a>
            </li>
            

        </ul>

    </article>

    <section id="container">

        <article id="content">
            <header id="content-header">
            <h1 id="content-title"> Bite Cell Scouting </h1>

            
                <div id="subtitle">
                    <div> 2019 Puzzle Hunt - Puzzle 10C </div>
                </div>
            

            </div>

            </header>

            <section id="content-body">
                <blockquote>
<p>This puzzle was released on 2019-04-06, and was the Challenge puzzle for the theme <em>Pretty Pictures</em>.</p>
</blockquote>
<p>It&rsquo;s 2:40am. Facing North, you walk through the corridor on the 5th wall.</p>
<p><img src="https://i.imgur.com/tROiy77.gif" alt="Imgur"></p>
<p>Time is pressing on. You don&rsquo;t want to forever be known as &ldquo;the late intern&rdquo;&hellip;.You&rsquo;ve had nightmares of this before.</p>
<p>You open the book on the table. It&rsquo;s called <em>Hospital of Babel Submission Proposal: A Comprehensive Look at Bite Cell Morphology</em>.</p>
<p>Ah, haematology, your old nemesis. Bite cells&hellip;what did they indicate again?</p>
<p>You take a read.</p>
<blockquote>
<p>The Bite Cell Scouter is being developed by the Hospital of Babel in order to collect morphology images of bite cells on a large scale.</p>
</blockquote>
<blockquote>
<p>The Scouter divides high-power microscopy images of blood films into <code>217x217</code> squares and identifies bounding boxes of each bite cell for later extraction and cataloguing.</p>
</blockquote>
<blockquote>
<p>The images look like the following:</p>
</blockquote>
<p><img src="https://lh3.googleusercontent.com/AQF-tP1H7rVtT6jPL5MyejPgxxJmWi6tG7eXuM8JeI_fCPpyDxjbewN0jVmzCQnDHPXyd0yrSQsZEfCo7zJfhj026KUnCSYiq_6vW87yPhD-yMITOcUV4SkB9ZyVEFDq60Ytm0CySQ=s231-p-k" alt="Image"></p>
<blockquote>
<p>Your task is to implement The Scouter and determine the centre of each bounding box of each bite cell in the test dataset.</p>
</blockquote>
<blockquote>
<p>You are provided with two folders containing 400 images each. Each image looks like this: note that the background for every image has an alpha value of 0, or is pure white if converted to RGB; you may find this useful for segmentation purposes. The only cells present in each image are normal RBCs or bite cells.</p>
</blockquote>
<blockquote>
<p>The first directory, <code>input10_training/</code> contains 400 images of blood films under high power, cropped to a <code>217x217</code> pixels and saved as <code>.png</code> files of the form <code>training_XXX.png</code> for some three-digit ID <code>XXX</code> (e.g. <code>training_001.png</code>). This directory also contains a comma-separated-value file called <code>labels.csv</code> that contains data on bounding boxes of every cell the following format (note there is no header row):</p>
</blockquote>
<blockquote>
<pre><code class="language-csv" data-lang="csv">training_001.png,BITE,2,155,21,173
training_001.png,NORMAL,66,112,86,134
training_001.png,NORMAL,0,194,16,213
etc.
</code></pre></blockquote>
<blockquote>
<p>Each value corresponds to, in this exact order:</p>
</blockquote>
<blockquote>
<ol>
<li>The filename of the image file</li>
<li>The classification of a bounding box (either <code>NORMAL</code> or <code>BITE</code>)</li>
<li>The <strong>left</strong> coordinate of the bounding box</li>
<li>The <strong>upper</strong> coordinate of the bounding box</li>
<li>The <strong>right</strong> coordinate of the bounding box</li>
<li>The <strong>bottom</strong> coordinate of the bounding box.</li>
</ol>
</blockquote>
<blockquote>
<p>Please note, and <em>this is absolutely vital</em>, that the coordinates of the bounding box <strong>are relative to the upper left corner of the image</strong>. This is why the <code>bottom</code> coordinate of the bounding box has a greater value than the <code>upper</code> coordinate of the bounding box (the upper-left corner has a y-axis value of 0, and the bottom-left corner has a y-axis value of 217). The x-axis remains as usual (i.e. the upper-left corner has a x-axis value of 0, and the upper-right corner has an x-axis value of 217). If you have any doubt, first extract the bounding box of a test image and ensure this corresponds to a red blood cell.</p>
</blockquote>
<blockquote>
<p>The second directory, <code>input10_test/</code> contains 400 images of blood films similar to the images in the training dataset.</p>
</blockquote>
<blockquote>
<p>Identify the bounding boxes of every bite cell in the test dataset, then find the centre of each bounding box. If you plot the centre of every bounding box for every image (with <strong>the origin defined as upper-left, as per the images</strong>), a numerical code will be revealed.</p>
</blockquote>
<blockquote>
<p>For example, for the image above, the centers of the bite cells <em>only</em> would look like this:</p>
</blockquote>
<p><img src="https://lh3.googleusercontent.com/NiSh-25wHyiRzJCqhr9J1SB3gccdBEMiJdlhYQ0PAPh9tHjz0_XEj4YzLd8ISisJtSvzxBl4f8krFddk6t8FclOEDWJwG28trBpO8NbZ27GSdrAfGfKsnCRLgBhZu_6cbXfIvJL2AA=w800" alt="Image"></p>
<blockquote>
<p>This doesn&rsquo;t resemble digits at the moment, but once you collect and classify enough images, you the plotted centers should accumulate to form digits.</p>
</blockquote>
<!-- raw HTML omitted -->
<h2 id="input">Input</h2>
<p><a href="https://drive.google.com/drive/folders/1b_4xC1liMmWA7xAXtmM3UgoDXX-lWVQ0?usp=sharing">cgmnt_input10/</a>, containing</p>
<ol>
<li><code>input10_training/</code> (400 training ID-labelled 217x217 pixel PNG images and 1 bounding box data file (<code>labels.csv</code>), 5.7MB total),</li>
<li><code>input10_test/</code> (400 test ID-labelled 217x217 pixel PNG images,  5.9MB total).</li>
</ol>
<h2 id="statement">Statement</h2>
<p>State the numerical code revealed by plotting the bounding box centre of every bite cell in the test dataset.</p>
<h2 id="references">References</h2>
<p>Written by the CIGMAH Puzzle Hunt team. We also generated the images; no external images were used in the process. The image generation process is detailed in the Writer&rsquo;s Notes after the puzzle is solved.</p>
<h2 id="answer">Answer</h2>
<p>The correct solution was <code>412</code>.</p>
<h2 id="explanation">Explanation</h2>
<h3 id="map-hint">Map Hint</h3>
<p>You feel satisfied for having been able to detect and localise bite cells automatically, though you wonder what research the Hospital of Babel would do with lots of pictures of bite cells&hellip;</p>
<p>You open the file <code>map_hint.txt</code>. It contains the following:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">Key from &#34;La Biblioteca de Babel&#34;:

    ...es analogo a un dios.
</code></pre></div><p>Puzzling indeed.</p>
<h3 id="writers-notes">Writer&rsquo;s Notes</h3>
<h4 id="objectives">Objectives</h4>
<ol>
<li>Introduce applications of computer vision (object detection) and machine learning in medical image interpretation.</li>
<li>Provide sample, sanitised training and test data for object detection, of reasonable similarity to medical images.</li>
</ol>
<h4 id="context">Context</h4>
<p>Object detection is a useful task in many medical contexts; pathology and radiology images in particular house a huge number of components in each image, and being able to automatically detect certain components is an important element to interpretation.</p>
<p>We chose a small problem that we could feasibly generate data for, settling on a RBC-only &ldquo;blood film&rdquo; with the task of identifying a certain morphology. Although our task is relatively easy as far as object detection goes, we hope it introduces some basic principles behind.</p>
<h4 id="example-solution">Example Solution</h4>
<blockquote>
<p>Note: Our example solutions are just one way of approaching our puzzles. They&rsquo;re not necessarily the best way, or even a good way!</p>
</blockquote>
<p>Our solution makes use of easy segmentation between background and red-blood cells to find &ldquo;proposed&rdquo; regions for red blood cells by binary hole-filling and connected component labelling on the test image dataset. While certain object detection architectures could do this in a more general sense (e.g. RCNN, YOLO), these are more computationally expensive. Although our images are highly sanitised to allow very easy foreground-background separation, the nature of many actual blood film images means that a comparably simple foreground-background separation step may be feasible on real data (though with more sophisticated segmentation techniques).</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">tensorflow</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">tf</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">keras</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">matplotlib.pyplot</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">plt</span>
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">matplotlib.colors</span> <span style="color:#008000;font-weight:bold">import</span> rgb_to_hsv
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">scipy.ndimage.morphology</span> <span style="color:#008000;font-weight:bold">import</span> binary_fill_holes
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">skimage.measure</span> <span style="color:#008000;font-weight:bold">import</span> label, regionprops
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">pandas</span> <span style="color:#008000;font-weight:bold">import</span> read_csv
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">glob</span> <span style="color:#008000;font-weight:bold">import</span> glob
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">imageio</span> <span style="color:#008000;font-weight:bold">import</span> imread
</code></pre></div><pre><code>Using TensorFlow backend.
</code></pre>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#408080;font-style:italic">### PREPROCESSING</span>
traindir <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_training/&#34;</span>
traindata <span style="color:#666">=</span> read_csv(<span style="color:#ba2121">&#34;./input10_training/labels.csv&#34;</span>, names<span style="color:#666">=</span>[<span style="color:#ba2121">&#34;fname&#34;</span>, <span style="color:#ba2121">&#34;class&#34;</span>, <span style="color:#ba2121">&#34;left&#34;</span>, <span style="color:#ba2121">&#34;upper&#34;</span>, <span style="color:#ba2121">&#34;right&#34;</span>, <span style="color:#ba2121">&#34;bottom&#34;</span>])
trainfs <span style="color:#666">=</span> <span style="color:#008000">list</span>(<span style="color:#008000">dict</span><span style="color:#666">.</span>fromkeys(traindata[<span style="color:#ba2121">&#34;fname&#34;</span>])) <span style="color:#408080;font-style:italic"># For Python &gt; 3.6 only! Needs to be ordered.</span>
traingroups <span style="color:#666">=</span> [traindata[traindata[<span style="color:#ba2121">&#34;fname&#34;</span>] <span style="color:#666">==</span> f] <span style="color:#008000;font-weight:bold">for</span> f <span style="color:#a2f;font-weight:bold">in</span> trainfs]
trainims <span style="color:#666">=</span> [binary_fill_holes(rgb_to_hsv(imread(traindir <span style="color:#666">+</span> f)[:,:,<span style="color:#666">0</span>:<span style="color:#666">3</span>])[:,:,<span style="color:#666">2</span>]<span style="color:#666">&lt;</span><span style="color:#666">255</span>) <span style="color:#008000;font-weight:bold">for</span> f <span style="color:#a2f;font-weight:bold">in</span> trainfs]
trainbbs <span style="color:#666">=</span> [im[r<span style="color:#666">.</span>upper:r<span style="color:#666">.</span>bottom, r<span style="color:#666">.</span>left:r<span style="color:#666">.</span>right] <span style="color:#008000;font-weight:bold">for</span> im, g <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">zip</span>(trainims, traingroups) <span style="color:#008000;font-weight:bold">for</span> i, r <span style="color:#a2f;font-weight:bold">in</span> g<span style="color:#666">.</span>iterrows()]
maxy, maxx <span style="color:#666">=</span> <span style="color:#008000">map</span>(np<span style="color:#666">.</span>max, (traindata<span style="color:#666">.</span>bottom <span style="color:#666">-</span> traindata<span style="color:#666">.</span>upper, traindata<span style="color:#666">.</span>right <span style="color:#666">-</span> traindata<span style="color:#666">.</span>left))
trainpad <span style="color:#666">=</span> [np<span style="color:#666">.</span>pad(im, ((maxy<span style="color:#666">-</span>im<span style="color:#666">.</span>shape[<span style="color:#666">0</span>],<span style="color:#666">0</span>),(maxx<span style="color:#666">-</span>im<span style="color:#666">.</span>shape[<span style="color:#666">1</span>],<span style="color:#666">0</span>)), <span style="color:#ba2121">&#39;constant&#39;</span>) <span style="color:#008000;font-weight:bold">for</span> im <span style="color:#a2f;font-weight:bold">in</span> trainbbs]
trainlabs <span style="color:#666">=</span> [<span style="color:#666">0</span> <span style="color:#008000;font-weight:bold">if</span> r[<span style="color:#ba2121">&#34;class&#34;</span>] <span style="color:#666">==</span> <span style="color:#ba2121">&#34;NORMAL&#34;</span> <span style="color:#008000;font-weight:bold">else</span> <span style="color:#666">1</span> <span style="color:#008000;font-weight:bold">for</span> i, r <span style="color:#a2f;font-weight:bold">in</span> traindata<span style="color:#666">.</span>iterrows()]

<span style="color:#408080;font-style:italic">### MODEL</span>
model <span style="color:#666">=</span> keras<span style="color:#666">.</span>Sequential([
    keras<span style="color:#666">.</span>layers<span style="color:#666">.</span>Flatten(input_shape<span style="color:#666">=</span>(maxy,maxx)),
    keras<span style="color:#666">.</span>layers<span style="color:#666">.</span>Dense(<span style="color:#666">128</span>, activation<span style="color:#666">=</span>tf<span style="color:#666">.</span>nn<span style="color:#666">.</span>relu),
    keras<span style="color:#666">.</span>layers<span style="color:#666">.</span>Dense(<span style="color:#666">128</span>, activation<span style="color:#666">=</span>tf<span style="color:#666">.</span>nn<span style="color:#666">.</span>relu),
    keras<span style="color:#666">.</span>layers<span style="color:#666">.</span>Dense(<span style="color:#666">128</span>, activation<span style="color:#666">=</span>tf<span style="color:#666">.</span>nn<span style="color:#666">.</span>relu),
    keras<span style="color:#666">.</span>layers<span style="color:#666">.</span>Dense(<span style="color:#666">2</span>, activation<span style="color:#666">=</span>tf<span style="color:#666">.</span>nn<span style="color:#666">.</span>softmax)
])
model<span style="color:#666">.</span>compile(optimizer<span style="color:#666">=</span><span style="color:#ba2121">&#39;adam&#39;</span>, loss<span style="color:#666">=</span><span style="color:#ba2121">&#39;sparse_categorical_crossentropy&#39;</span>, metrics<span style="color:#666">=</span>[<span style="color:#ba2121">&#39;accuracy&#39;</span>])
model<span style="color:#666">.</span>fit(np<span style="color:#666">.</span>stack(trainpad, axis<span style="color:#666">=</span><span style="color:#666">0</span>), np<span style="color:#666">.</span>array(trainlabs), epochs<span style="color:#666">=</span><span style="color:#666">5</span>)

<span style="color:#408080;font-style:italic">### TESTING</span>
testglob <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_test/*.png&#34;</span>
testfs <span style="color:#666">=</span> <span style="color:#008000">sorted</span>(glob(testglob))
testims <span style="color:#666">=</span> [binary_fill_holes(rgb_to_hsv(imread(f)[:,:,<span style="color:#666">0</span>:<span style="color:#666">3</span>])[:,:,<span style="color:#666">2</span>]<span style="color:#666">&lt;</span><span style="color:#666">255</span>) <span style="color:#008000;font-weight:bold">for</span> f <span style="color:#a2f;font-weight:bold">in</span> testfs]
testrs <span style="color:#666">=</span> [regionprops(label(im, background<span style="color:#666">=</span>False)) <span style="color:#008000;font-weight:bold">for</span> im <span style="color:#a2f;font-weight:bold">in</span> testims]
testbbco <span style="color:#666">=</span> [[r<span style="color:#666">.</span>bbox <span style="color:#008000;font-weight:bold">for</span> r <span style="color:#a2f;font-weight:bold">in</span> rs <span style="color:#008000;font-weight:bold">if</span> (<span style="color:#008000;font-weight:bold">lambda</span> b: b[<span style="color:#666">2</span>]<span style="color:#666">-</span>b[<span style="color:#666">0</span>]<span style="color:#666">&lt;</span>maxy <span style="color:#a2f;font-weight:bold">and</span> b[<span style="color:#666">3</span>]<span style="color:#666">-</span>b[<span style="color:#666">1</span>] <span style="color:#666">&lt;</span> maxx)(r<span style="color:#666">.</span>bbox)] <span style="color:#008000;font-weight:bold">for</span> rs <span style="color:#a2f;font-weight:bold">in</span> testrs]
testbbs <span style="color:#666">=</span> [im[b[<span style="color:#666">0</span>]:b[<span style="color:#666">2</span>], b[<span style="color:#666">1</span>]:b[<span style="color:#666">3</span>]] <span style="color:#008000;font-weight:bold">for</span> im, bs <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">zip</span>(testims, testbbco) <span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> bs]
testpad <span style="color:#666">=</span> [np<span style="color:#666">.</span>pad(im, ((maxy<span style="color:#666">-</span>im<span style="color:#666">.</span>shape[<span style="color:#666">0</span>],<span style="color:#666">0</span>),(maxx<span style="color:#666">-</span>im<span style="color:#666">.</span>shape[<span style="color:#666">1</span>],<span style="color:#666">0</span>)), <span style="color:#ba2121">&#39;constant&#39;</span>) <span style="color:#008000;font-weight:bold">for</span> im <span style="color:#a2f;font-weight:bold">in</span> testbbs]
preds <span style="color:#666">=</span> [np<span style="color:#666">.</span>argmax(p) <span style="color:#008000;font-weight:bold">for</span> p <span style="color:#a2f;font-weight:bold">in</span> model<span style="color:#666">.</span>predict(np<span style="color:#666">.</span>stack(testpad, axis<span style="color:#666">=</span><span style="color:#666">0</span>))]

<span style="color:#408080;font-style:italic">### BITE CENTRE PLOT</span>
testbbcoflat <span style="color:#666">=</span> [b <span style="color:#008000;font-weight:bold">for</span> bs <span style="color:#a2f;font-weight:bold">in</span> testbbco <span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> bs]
testxs <span style="color:#666">=</span> [b[<span style="color:#666">1</span>]<span style="color:#666">+</span>(b[<span style="color:#666">3</span>]<span style="color:#666">-</span>b[<span style="color:#666">1</span>])<span style="color:#666">//</span><span style="color:#666">2</span> <span style="color:#008000;font-weight:bold">for</span> b,c <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">zip</span>(testbbcoflat,preds) <span style="color:#008000;font-weight:bold">if</span> c]
testys <span style="color:#666">=</span> [b[<span style="color:#666">2</span>]<span style="color:#666">+</span>(b[<span style="color:#666">2</span>]<span style="color:#666">-</span>b[<span style="color:#666">0</span>])<span style="color:#666">//</span><span style="color:#666">2</span> <span style="color:#008000;font-weight:bold">for</span> b,c <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">zip</span>(testbbcoflat,preds) <span style="color:#008000;font-weight:bold">if</span> c]

f,ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(<span style="color:#666">1</span>)
ax<span style="color:#666">.</span>set_aspect(<span style="color:#ba2121">&#34;equal&#34;</span>)
ax<span style="color:#666">.</span>scatter(testxs, testys, s<span style="color:#666">=</span><span style="color:#666">1</span>, c<span style="color:#666">=</span><span style="color:#ba2121">&#34;black&#34;</span>)
ax<span style="color:#666">.</span>set_ylim((<span style="color:#008000">max</span>(testys), <span style="color:#666">0</span>))
ax<span style="color:#666">.</span>set_xlim((<span style="color:#666">0</span>, <span style="color:#008000">max</span>(testxs)))
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">    Epoch 1/5
    11780/11780 [==============================] - 2s 161us/step - loss: 0.1748 - acc: 0.9346
    Epoch 2/5
    11780/11780 [==============================] - 2s 156us/step - loss: 0.1114 - acc: 0.9633
    Epoch 3/5
    11780/11780 [==============================] - 2s 132us/step - loss: 0.0877 - acc: 0.9717
    Epoch 4/5
    11780/11780 [==============================] - 2s 145us/step - loss: 0.0853 - acc: 0.9721
    Epoch 5/5
    11780/11780 [==============================] - 2s 140us/step - loss: 0.0773 - acc: 0.9767
</code></pre></div><p><img src="https://lh3.googleusercontent.com/dbGv934qxMzZwakbKxrDRLNtQzyPAda5wrEDdd9e5GwY1PDpP_tLXM8ayCXSP-qf-Z5BeS6z_4kBZcYUJRLq8MANJ5wdpiJpJfnuyHrBiq8idmpTCF9DhBpQtAimLAzfvaAiLlgqhg=w800" alt="png"></p>
<p>Here, we can see the classification accuracy is not 100% (mostly at the image edges, which is expected as these RBCs are often cut-off), but even so we can very clearly make out a three-digit number: <code>412</code>.</p>
<p>We&rsquo;ve written this in a very dense style for brevity, which some may disagree with, but in the words of Arthur Whitney&hellip; &ldquo;hate scrolling.&rdquo;</p>
<p>Here&rsquo;s a rundown of how this solution works. We were unfortunately time-poor this month with a variety of other tasks, so our discussion of this is not in any particular depth (though you can read the code to see exactly what it&rsquo;s doing), but as a general outline:</p>
<ol>
<li>The training images are binarised by the value portion of the HSV-converted image (taking anything non-white) and holes are filled  (where the central clearing of red blood cells may be pure white if the opacity is low enough).</li>
<li>Bounding box-cropped images are extracted from all the training images and padded to the maximum bounding box size.</li>
<li>The (very simple) CNN model is trained on all the padded bounding boxes. We didn&rsquo;t exhaustively look for any particularly good models, just whatever was sufficient for this puzzle.</li>
<li>The test images are binarised and hole-filled as above, then connected components are labelled and filtered rudimentarily to remove anything above the maximum bbox size (we discard many labelled components where RBCs overlap here, but there remain sufficient cells for this puzzle).</li>
<li>Bounding box-cropped images for each components are extracted and classified using the model.</li>
<li>The centre of each bounding box-cropped image classified as a bite cell is extracted and plotted on a scatter plot with the origin defined as the upper-left corner (as per the specification).</li>
</ol>
<p>Here&rsquo;s a few images of the binarised and cropped bounding boxes for one of the images as an example.</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#666">.</span>imshow(trainims[<span style="color:#666">0</span>], cmap<span style="color:#666">=</span><span style="color:#ba2121">&#34;gray&#34;</span>)
</code></pre></div><p><img src="https://lh3.googleusercontent.com/VVlXGJ6nqsuNUAFHiKno9VO-L4ThOrV-uH42Q1VOzIPb_vQgma82LxvNI0ThxzHrTSfhkx0IJNsW0RG16lEB8DDiPDamy1Veh14pnY2HCTqy4PYT8s-8DMuPHTC3HoXo7jUnLGmKZA=w800" alt="png"></p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#666">.</span>imshow(trainbbs[<span style="color:#666">0</span>], cmap<span style="color:#666">=</span><span style="color:#ba2121">&#34;gray&#34;</span>)
</code></pre></div><p><img src="https://lh3.googleusercontent.com/Uf9fFQF-VTgtdEAlPISNFtEhVeBk9ETluSKVudnkCJ4rFp4ssFcoRUnJ_u4G7A72gwD4hCK600QjOjmKkU4lqo2TuIhQtfyDBQ3j783K7dy9OSqjiq-0HDl1eCRS37nSUavj9pcGTA=w800" alt="png"></p>
<p>And with padding:</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">plt<span style="color:#666">.</span>imshow(trainpad[<span style="color:#666">0</span>], cmap<span style="color:#666">=</span><span style="color:#ba2121">&#34;gray&#34;</span>)
</code></pre></div><pre><code>&lt;matplotlib.image.AxesImage at 0x7f9f62498710&gt;
</code></pre>
<p><img src="https://lh3.googleusercontent.com/uSn1yP-PkSfg0wDA9muO-XLLs-inTn7zXw5QhbawZgMWJQkD4t-4z1oCjdXwzJ5uXPqHuIgqVoDwhqW78BAbRQlktUWxTwDdJ_3sCjYoOJhW8j0nOuXUZz-NNSc3Ymt0DEmN941SdQ=w800" alt="png"></p>
<h4 id="image-generation">Image Generation</h4>
<p>We were very time-pressured this month, so our code below is not optimised, nor concise, nor efficient. We hope to clean this up one day, as it mostly consists of array operations. We continuously dream of the day we can fit our code on a business card in APL&hellip;</p>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">matplotlib</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">numpy</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">np</span>
<span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">matplotlib</span> <span style="color:#008000;font-weight:bold">import</span> pyplot <span style="color:#008000;font-weight:bold">as</span> plt
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">matplotlib.cm</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">cm</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">itertools</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">random</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL.Image</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">Image</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL.ImageFilter</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">ImageFilter</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL.ImageChops</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">ImageChops</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL.ImageDraw</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">ImageDraw</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">PIL.ImageEnhance</span> <span style="color:#008000;font-weight:bold">as</span> <span style="color:#00f;font-weight:bold">ImageEnhance</span>
<span style="color:#008000;font-weight:bold">import</span> <span style="color:#00f;font-weight:bold">math</span>
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#666">%</span>matplotlib inline
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">from</span> <span style="color:#00f;font-weight:bold">matplotlib</span> <span style="color:#008000;font-weight:bold">import</span> patches
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">imsize <span style="color:#666">=</span> <span style="color:#666">200</span>

rrbc <span style="color:#666">=</span> imsize <span style="color:#666">//</span> <span style="color:#666">20</span>
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">make_base</span>():
    fig, ax <span style="color:#666">=</span> plt<span style="color:#666">.</span>subplots(figsize<span style="color:#666">=</span>(<span style="color:#666">4</span>,<span style="color:#666">4</span>))
    ax<span style="color:#666">.</span>axis(<span style="color:#ba2121">&#34;off&#34;</span>)
    ax<span style="color:#666">.</span>patch<span style="color:#666">.</span>set_alpha(<span style="color:#666">0</span>)
    ax<span style="color:#666">.</span>set_ylim([<span style="color:#666">0</span>, imsize])
    ax<span style="color:#666">.</span>set_xlim([<span style="color:#666">0</span>, imsize])
    ax<span style="color:#666">.</span>set_axis_off()
    ax<span style="color:#666">.</span>margins(<span style="color:#666">0</span>,<span style="color:#666">0</span>)
    ax<span style="color:#666">.</span>xaxis<span style="color:#666">.</span>set_major_locator(plt<span style="color:#666">.</span>NullLocator())
    ax<span style="color:#666">.</span>yaxis<span style="color:#666">.</span>set_major_locator(plt<span style="color:#666">.</span>NullLocator())
    <span style="color:#008000;font-weight:bold">return</span> fig, ax
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">rand_around</span>(mean, std, clip_low<span style="color:#666">=</span><span style="color:#666">0</span>, clip_high<span style="color:#666">=</span><span style="color:#666">1</span>):
    result <span style="color:#666">=</span> np<span style="color:#666">.</span>random<span style="color:#666">.</span>normal(mean, std)
    <span style="color:#008000;font-weight:bold">if</span> result <span style="color:#666">&lt;</span> clip_low:
        <span style="color:#008000;font-weight:bold">return</span> clip_low
    <span style="color:#008000;font-weight:bold">if</span> result <span style="color:#666">&gt;</span> clip_high:
        <span style="color:#008000;font-weight:bold">return</span> clip_high
    <span style="color:#008000;font-weight:bold">return</span> result
</code></pre></div><h5 id="solution-digits">Solution Digits</h5>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">solution <span style="color:#666">=</span> np<span style="color:#666">.</span>array([
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">0</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>],
    [<span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>, <span style="color:#666">0</span>]
])

ysize, xsize <span style="color:#666">=</span> solution<span style="color:#666">.</span>shape

solution <span style="color:#666">=</span> solution<span style="color:#666">.</span>repeat(<span style="color:#666">20</span>, axis<span style="color:#666">=</span><span style="color:#666">0</span>)<span style="color:#666">.</span>repeat(<span style="color:#666">20</span>, axis<span style="color:#666">=</span><span style="color:#666">1</span>)

ysol, xsol <span style="color:#666">=</span> np<span style="color:#666">.</span>nonzero(solution)

psol <span style="color:#666">=</span> <span style="color:#008000">set</span>(<span style="color:#008000">zip</span>(xsol, imsize<span style="color:#666">-</span>ysol))
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">insolution</span>(p):
    <span style="color:#008000;font-weight:bold">return</span> p <span style="color:#a2f;font-weight:bold">in</span> psol
</code></pre></div><h5 id="rbc-function">RBC Function</h5>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">random_sign</span>():
    <span style="color:#008000;font-weight:bold">return</span> <span style="color:#666">1</span> <span style="color:#008000;font-weight:bold">if</span> random<span style="color:#666">.</span>random() <span style="color:#666">&lt;</span> <span style="color:#666">0.5</span> <span style="color:#008000;font-weight:bold">else</span> <span style="color:#666">-</span><span style="color:#666">1</span>
</code></pre></div><div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">innercol <span style="color:#666">=</span> np<span style="color:#666">.</span>array(
    [<span style="color:#666">0.91</span>,
     <span style="color:#666">0.49</span>,
     <span style="color:#666">0.65</span>,
     <span style="color:#666">0</span>]
)

bodycol<span style="color:#666">=</span> np<span style="color:#666">.</span>array(
    [<span style="color:#666">0.91</span>,
     <span style="color:#666">0.49</span>,
     <span style="color:#666">0.65</span>,
     <span style="color:#666">0.9</span>
    ]
)

<span style="color:#408080;font-style:italic">### Avoid collisions and cutoff rbcs</span>
xoptions <span style="color:#666">=</span> <span style="color:#008000">range</span>(rrbc, imsize, <span style="color:#008000">int</span>(imsize <span style="color:#666">/</span> rrbc))
yoptions <span style="color:#666">=</span> <span style="color:#008000">range</span>(rrbc, imsize, <span style="color:#008000">int</span>(imsize <span style="color:#666">/</span> rrbc))

xyoptions <span style="color:#666">=</span> [(x, y) <span style="color:#008000;font-weight:bold">for</span> x <span style="color:#a2f;font-weight:bold">in</span> xoptions <span style="color:#008000;font-weight:bold">for</span> y <span style="color:#a2f;font-weight:bold">in</span> yoptions]

<span style="color:#008000;font-weight:bold">def</span> <span style="color:#00f">make_rbc</span>(propbite<span style="color:#666">=</span><span style="color:#666">0.2</span>, checkinsolution<span style="color:#666">=</span>False):
    fig, ax <span style="color:#666">=</span> make_base()

    num_cells <span style="color:#666">=</span> random<span style="color:#666">.</span>randint(<span style="color:#666">20</span>, <span style="color:#666">40</span>)
    bitecoords <span style="color:#666">=</span> []

    <span style="color:#408080;font-style:italic"># Check solution</span>
    <span style="color:#408080;font-style:italic"># ax.imshow(solution, cmap=cm.Greys)</span>

    xyrbcs <span style="color:#666">=</span> random<span style="color:#666">.</span>sample(xyoptions, k<span style="color:#666">=</span>num_cells)

    bboxes <span style="color:#666">=</span> []

    <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(num_cells):

        inner <span style="color:#666">=</span> rand_around(rrbc <span style="color:#666">/</span> <span style="color:#666">4</span>, rrbc<span style="color:#666">/</span><span style="color:#666">16</span>, <span style="color:#666">0.1</span>, rrbc <span style="color:#666">/</span> <span style="color:#666">2</span>)

        xycentre <span style="color:#666">=</span> xyrbcs[i]

        xcentre <span style="color:#666">=</span> xycentre[<span style="color:#666">0</span>] <span style="color:#666">+</span> random<span style="color:#666">.</span>randint(<span style="color:#008000">int</span>(<span style="color:#666">-</span>rrbc<span style="color:#666">/</span><span style="color:#666">2</span>), <span style="color:#008000">int</span>(rrbc<span style="color:#666">/</span><span style="color:#666">2</span>))
        ycentre <span style="color:#666">=</span> xycentre[<span style="color:#666">1</span>] <span style="color:#666">+</span> random<span style="color:#666">.</span>randint(<span style="color:#008000">int</span>(<span style="color:#666">-</span>rrbc<span style="color:#666">/</span><span style="color:#666">2</span>), <span style="color:#008000">int</span>(rrbc<span style="color:#666">/</span><span style="color:#666">2</span>))

        innercol[<span style="color:#666">3</span>] <span style="color:#666">=</span> rand_around(<span style="color:#666">0.3</span>, <span style="color:#666">0.2</span>, <span style="color:#666">0</span>, <span style="color:#666">0.7</span>)

        imcontainer <span style="color:#666">=</span> np<span style="color:#666">.</span>zeros((imsize, imsize, <span style="color:#666">4</span>))

        xdeform <span style="color:#666">=</span> rand_around(<span style="color:#666">8</span>, <span style="color:#666">3</span>, <span style="color:#666">4</span>, <span style="color:#666">12</span>)
        xdscale <span style="color:#666">=</span> rand_around(<span style="color:#666">1</span>, <span style="color:#666">1.5</span>, <span style="color:#666">0</span>, <span style="color:#666">2.5</span>)
        xpshift <span style="color:#666">=</span> random<span style="color:#666">.</span>uniform(<span style="color:#666">0</span>, np<span style="color:#666">.</span>pi)
        ydeform <span style="color:#666">=</span> rand_around(<span style="color:#666">8</span>, <span style="color:#666">3</span>, <span style="color:#666">4</span>, <span style="color:#666">12</span>)
        ydscale <span style="color:#666">=</span> rand_around(<span style="color:#666">1</span>, <span style="color:#666">1.5</span>, <span style="color:#666">0</span>, <span style="color:#666">2.5</span>)
        ypshift <span style="color:#666">=</span> random<span style="color:#666">.</span>uniform(<span style="color:#666">0</span>, np<span style="color:#666">.</span>pi)

        minx <span style="color:#666">=</span> imsize
        miny <span style="color:#666">=</span> imsize
        maxx <span style="color:#666">=</span> <span style="color:#666">0</span>
        maxy <span style="color:#666">=</span> <span style="color:#666">0</span>

        <span style="color:#008000;font-weight:bold">if</span> checkinsolution:
            usebite <span style="color:#666">=</span> insolution((xcentre, ycentre))
        <span style="color:#008000;font-weight:bold">else</span>:
            usebite <span style="color:#666">=</span> True

        <span style="color:#008000;font-weight:bold">if</span> random<span style="color:#666">.</span>random() <span style="color:#666">&lt;</span> propbite <span style="color:#a2f;font-weight:bold">and</span> usebite:
            isbite <span style="color:#666">=</span> True
            bitecoords<span style="color:#666">.</span>append((xcentre, ycentre))
            rbite <span style="color:#666">=</span> rand_around(rrbc <span style="color:#666">*</span> <span style="color:#666">1.5</span>, rrbc<span style="color:#666">/</span><span style="color:#666">4</span>, rrbc, rrbc<span style="color:#666">*</span><span style="color:#666">2</span>)
            xbite <span style="color:#666">=</span> xcentre <span style="color:#666">+</span> rrbc <span style="color:#666">*</span> (rand_around(<span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1.2</span>)) <span style="color:#666">*</span> random_sign()
            ybite <span style="color:#666">=</span> ycentre <span style="color:#666">+</span> rrbc <span style="color:#666">*</span> (rand_around(<span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1</span>, <span style="color:#666">1.2</span>)) <span style="color:#666">*</span> random_sign()
        <span style="color:#008000;font-weight:bold">else</span>:
            isbite <span style="color:#666">=</span> False

        <span style="color:#008000;font-weight:bold">for</span> y <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(imsize):
            <span style="color:#008000;font-weight:bold">for</span> x <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(imsize):
                dx <span style="color:#666">=</span> x <span style="color:#666">-</span> xcentre
                dy <span style="color:#666">=</span> y <span style="color:#666">-</span> ycentre

                <span style="color:#408080;font-style:italic"># Simple deformation</span>
                dx <span style="color:#666">=</span> dx <span style="color:#666">+</span> np<span style="color:#666">.</span>sin((y<span style="color:#666">+</span>xpshift) <span style="color:#666">/</span> (xdeform)) <span style="color:#666">*</span> xdscale
                dy <span style="color:#666">=</span> dy <span style="color:#666">+</span> np<span style="color:#666">.</span>sin((x<span style="color:#666">+</span>ypshift) <span style="color:#666">/</span> (ydeform)) <span style="color:#666">*</span> ydscale

                r <span style="color:#666">=</span> np<span style="color:#666">.</span>sqrt(dx <span style="color:#666">**</span> <span style="color:#666">2</span> <span style="color:#666">+</span> dy <span style="color:#666">**</span> <span style="color:#666">2</span>)

                <span style="color:#408080;font-style:italic"># Bite check</span>
                <span style="color:#008000;font-weight:bold">if</span> isbite:
                    dxbite <span style="color:#666">=</span> x<span style="color:#666">-</span>xbite
                    dybite <span style="color:#666">=</span> y<span style="color:#666">-</span>ybite
                    dbite <span style="color:#666">=</span> np<span style="color:#666">.</span>sqrt(dxbite <span style="color:#666">**</span> <span style="color:#666">2</span> <span style="color:#666">+</span> dybite <span style="color:#666">**</span> <span style="color:#666">2</span>)
                    <span style="color:#008000;font-weight:bold">if</span> dbite <span style="color:#666">&lt;</span> rbite:
                        rimwidth <span style="color:#666">=</span> rand_around(rbite <span style="color:#666">*</span> <span style="color:#666">1</span><span style="color:#666">/</span><span style="color:#666">10</span>, rbite <span style="color:#666">/</span> <span style="color:#666">30</span>, rbite <span style="color:#666">*</span> <span style="color:#666">1</span><span style="color:#666">/</span><span style="color:#666">20</span>, rbite <span style="color:#666">*</span> <span style="color:#666">1</span><span style="color:#666">/</span><span style="color:#666">3</span>)
                        <span style="color:#008000;font-weight:bold">if</span> rbite <span style="color:#666">-</span> dbite <span style="color:#666">&lt;</span> rimwidth <span style="color:#a2f;font-weight:bold">and</span> (r <span style="color:#666">&lt;</span> inner <span style="color:#a2f;font-weight:bold">or</span> r <span style="color:#666">&lt;</span> rrbc):
                            prop <span style="color:#666">=</span> np<span style="color:#666">.</span>cbrt(<span style="color:#008000">abs</span>(r <span style="color:#666">+</span> rrbc <span style="color:#666">/</span> <span style="color:#666">10</span> <span style="color:#666">-</span> inner) <span style="color:#666">/</span> <span style="color:#008000">abs</span>(rrbc <span style="color:#666">+</span> rrbc<span style="color:#666">/</span><span style="color:#666">10</span> <span style="color:#666">-</span> inner)) <span style="color:#408080;font-style:italic">#** (1 / 5)</span>
                            imcontainer[y, x] <span style="color:#666">=</span> bodycol <span style="color:#666">*</span> prop <span style="color:#666">+</span> (<span style="color:#666">1</span> <span style="color:#666">-</span> prop) <span style="color:#666">*</span> innercol
                        <span style="color:#008000;font-weight:bold">continue</span>

                <span style="color:#008000;font-weight:bold">if</span> r <span style="color:#666">&lt;</span> inner:
                    imcontainer[y, x] <span style="color:#666">=</span> innercol
                <span style="color:#008000;font-weight:bold">elif</span> r <span style="color:#666">&lt;</span> rrbc:
                    prop <span style="color:#666">=</span> np<span style="color:#666">.</span>cbrt((r <span style="color:#666">-</span> inner) <span style="color:#666">/</span> (rrbc <span style="color:#666">-</span> inner))
                    imcontainer[y, x] <span style="color:#666">=</span> (prop <span style="color:#666">*</span> bodycol) <span style="color:#666">+</span> ((<span style="color:#666">1</span><span style="color:#666">-</span>prop) <span style="color:#666">*</span> innercol)
                    <span style="color:#008000;font-weight:bold">if</span> x <span style="color:#666">&lt;</span> minx:
                        minx <span style="color:#666">=</span> x
                    <span style="color:#008000;font-weight:bold">elif</span> x <span style="color:#666">&gt;</span> maxx:
                        maxx <span style="color:#666">=</span> x
                    <span style="color:#008000;font-weight:bold">if</span> y <span style="color:#666">&lt;</span> miny:
                        miny <span style="color:#666">=</span> y
                    <span style="color:#008000;font-weight:bold">elif</span> y <span style="color:#666">&gt;</span> maxy:
                        maxy <span style="color:#666">=</span> y

        ax<span style="color:#666">.</span>imshow(imcontainer)
        bboxes<span style="color:#666">.</span>append((isbite, minx, imsize<span style="color:#666">-</span>maxy, maxx, imsize<span style="color:#666">-</span>miny))
<span style="color:#408080;font-style:italic">###    Plot</span>
<span style="color:#408080;font-style:italic">###    ax.scatter([p[0] for p in  bitecoords], [p[1] for p in bitecoords], s = 0.5)</span>
<span style="color:#408080;font-style:italic">###     bboxpatches = [patches.Rectangle((b[1], b[2]), (b[3]-b[1]), (b[4]-b[2]),</span>
<span style="color:#408080;font-style:italic">###                                      facecolor = &#34;None&#34;,</span>
<span style="color:#408080;font-style:italic">###                                      edgecolor = (&#34;red&#34; if b[0] else &#34;green&#34;))</span>
<span style="color:#408080;font-style:italic">###                    for b in bboxes]</span>

<span style="color:#408080;font-style:italic">###     [ax.add_patch(p) for p in bboxpatches]</span>

    <span style="color:#008000;font-weight:bold">return</span> fig, bboxes
</code></pre></div><h5 id="training-data">Training Data</h5>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">save_directory <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_training/&#34;</span>
bboxfile <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_training/labels.csv&#34;</span>

nimages <span style="color:#666">=</span> <span style="color:#666">400</span>

<span style="color:#408080;font-style:italic">###bboxdata = []</span>

factor <span style="color:#666">=</span> <span style="color:#666">217</span><span style="color:#666">/</span><span style="color:#666">200</span>

<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(bboxfile, <span style="color:#ba2121">&#34;a+&#34;</span>) <span style="color:#008000;font-weight:bold">as</span> outfile:
    <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">0</span>, nimages):
        fig, bboxes <span style="color:#666">=</span> make_rbc(propbite <span style="color:#666">=</span> <span style="color:#666">0.5</span>, checkinsolution<span style="color:#666">=</span>False)

        bboxes <span style="color:#666">=</span> <span style="color:#008000">list</span>(<span style="color:#008000">map</span>(<span style="color:#008000;font-weight:bold">lambda</span> b: (b[<span style="color:#666">0</span>],
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">1</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">2</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">3</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">4</span>]<span style="color:#666">*</span>factor)),
                          bboxes))

        fname <span style="color:#666">=</span> <span style="color:#ba2121">&#34;training_{0:03d}.png&#34;</span><span style="color:#666">.</span>format(i <span style="color:#666">+</span> <span style="color:#666">1</span>)
        fig<span style="color:#666">.</span>savefig(save_directory <span style="color:#666">+</span> fname, frameon<span style="color:#666">=</span>False, pad_inches<span style="color:#666">=</span><span style="color:#666">0</span>, bbox_inches<span style="color:#666">=</span><span style="color:#ba2121">&#34;tight&#34;</span>)
        plt<span style="color:#666">.</span>close()

        <span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> bboxes:
            outfile<span style="color:#666">.</span>write(
                <span style="color:#ba2121">&#34;{},{},{},{},{},{}</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span><span style="color:#666">.</span>format(fname,
                                           (<span style="color:#ba2121">&#34;BITE&#34;</span> <span style="color:#008000;font-weight:bold">if</span> b[<span style="color:#666">0</span>] <span style="color:#008000;font-weight:bold">else</span> <span style="color:#ba2121">&#34;NORMAL&#34;</span>),
                                           b[<span style="color:#666">1</span>],
                                           b[<span style="color:#666">2</span>],
                                           b[<span style="color:#666">3</span>],
                                           b[<span style="color:#666">4</span>]
                                          )
            )
        <span style="color:#008000;font-weight:bold">print</span>(i)
</code></pre></div><h5 id="test-data">Test Data</h5>
<div class="highlight"><pre style=";-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">save_directory <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_test/&#34;</span>
bboxfile <span style="color:#666">=</span> <span style="color:#ba2121">&#34;./input10_bboxes_test.csv&#34;</span>

nimages <span style="color:#666">=</span> <span style="color:#666">400</span>

bboxdata <span style="color:#666">=</span> []

factor <span style="color:#666">=</span> <span style="color:#666">217</span><span style="color:#666">/</span><span style="color:#666">200</span>

<span style="color:#008000;font-weight:bold">with</span> <span style="color:#008000">open</span>(bboxfile, <span style="color:#ba2121">&#34;a+&#34;</span>) <span style="color:#008000;font-weight:bold">as</span> outfile:
    <span style="color:#008000;font-weight:bold">for</span> i <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#008000">range</span>(<span style="color:#666">367</span>, nimages):
        fig, bboxes <span style="color:#666">=</span> make_rbc(propbite <span style="color:#666">=</span> <span style="color:#666">0.75</span>, checkinsolution<span style="color:#666">=</span>True)

        bboxes <span style="color:#666">=</span> <span style="color:#008000">list</span>(<span style="color:#008000">map</span>(<span style="color:#008000;font-weight:bold">lambda</span> b: (b[<span style="color:#666">0</span>],
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">1</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">2</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">3</span>]<span style="color:#666">*</span>factor),
                                     math<span style="color:#666">.</span>floor(b[<span style="color:#666">4</span>]<span style="color:#666">*</span>factor)),
                          bboxes))

        fname <span style="color:#666">=</span> <span style="color:#ba2121">&#34;test_{0:03d}.png&#34;</span><span style="color:#666">.</span>format(i <span style="color:#666">+</span> <span style="color:#666">1</span>)
        fig<span style="color:#666">.</span>savefig(save_directory <span style="color:#666">+</span> fname, frameon<span style="color:#666">=</span>False, pad_inches<span style="color:#666">=</span><span style="color:#666">0</span>, bbox_inches<span style="color:#666">=</span><span style="color:#ba2121">&#34;tight&#34;</span>)
        plt<span style="color:#666">.</span>close()

        <span style="color:#008000;font-weight:bold">for</span> b <span style="color:#a2f;font-weight:bold">in</span> bboxes:
            outfile<span style="color:#666">.</span>write(
                <span style="color:#ba2121">&#34;{},{},{},{},{},{}</span><span style="color:#b62;font-weight:bold">\n</span><span style="color:#ba2121">&#34;</span><span style="color:#666">.</span>format(fname,
                                           (<span style="color:#ba2121">&#34;BITE&#34;</span> <span style="color:#008000;font-weight:bold">if</span> b[<span style="color:#666">0</span>] <span style="color:#008000;font-weight:bold">else</span> <span style="color:#ba2121">&#34;NORMAL&#34;</span>),
                                           b[<span style="color:#666">1</span>],
                                           b[<span style="color:#666">2</span>],
                                           b[<span style="color:#666">3</span>],
                                           b[<span style="color:#666">4</span>]
                                          )
            )
        <span style="color:#008000;font-weight:bold">print</span>(i)
</code></pre></div>
            </section>

        </article>
    </section>

</section>


        </main>

        
        <footer>Contact us at <code> contact at cigmah dot org </code>.
</footer>
        

    </body>
</html>
